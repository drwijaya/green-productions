{% extends "base.html" %}
{% block title %}User Management{% endblock %}
{% block page_title %}User Management{% endblock %}

{% block content %}
<div class="page-header mb-4">
    <div class="page-header-left">
        <p class="text-muted">Kelola user dan hak akses sistem</p>
    </div>
    <div class="page-header-right">
        <button class="btn btn-primary" onclick="openNewUserModal()">
            <i class="fas fa-user-plus"></i> Tambah User
        </button>
    </div>
</div>

<!-- Stats Cards -->
<div class="stats-grid mb-4">
    <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-users"></i></div>
        <div class="stat-info">
            <div class="stat-value" id="totalUsers">{{ users.total }}</div>
            <div class="stat-label">Total Users</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon active"><i class="fas fa-user-check"></i></div>
        <div class="stat-info">
            <div class="stat-value" id="activeUsers">-</div>
            <div class="stat-label">Active Users</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon admin"><i class="fas fa-user-shield"></i></div>
        <div class="stat-info">
            <div class="stat-value" id="adminCount">-</div>
            <div class="stat-label">Admins</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon operator"><i class="fas fa-user-cog"></i></div>
        <div class="stat-info">
            <div class="stat-value" id="operatorCount">-</div>
            <div class="stat-label">Operators</div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <div class="filters-row">
            <div class="filter-group search-group">
                <i class="fas fa-search"></i>
                <input type="text" class="form-input" id="searchInput" placeholder="Cari username, email, atau nama...">
            </div>
            <div class="filter-group">
                <select class="form-select" id="roleFilter">
                    <option value="">Semua Role</option>
                    <option value="admin">Admin</option>
                    <option value="owner">Owner</option>
                    <option value="admin_produksi">Admin Produksi</option>
                    <option value="qc_line">QC Line</option>
                    <option value="operator">Operator</option>
                </select>
            </div>
            <div class="filter-group">
                <select class="form-select" id="statusFilter">
                    <option value="">Semua Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Users Table -->
<div class="card">
    <div class="card-body">
        <div class="table-container">
            <table class="table" id="usersTable">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Last Login</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in users.items %}
                    <tr data-id="{{ u.id }}" data-role="{{ u.role }}"
                        data-status="{{ 'active' if u.is_active else 'inactive' }}">
                        <td>
                            <div class="user-cell">
                                <div class="user-avatar">{{ u.full_name[:2].upper() }}</div>
                                <div class="user-info">
                                    <div class="user-name">{{ u.full_name }}</div>
                                    <div class="user-username">@{{ u.username }}</div>
                                </div>
                            </div>
                        </td>
                        <td>{{ u.email }}</td>
                        <td>
                            <span class="role-badge role-{{ u.role }}">
                                <i
                                    class="fas {{ 'fa-shield-alt' if u.role == 'admin' else 'fa-crown' if u.role == 'owner' else 'fa-clipboard-list' if u.role == 'admin_produksi' else 'fa-search' if u.role == 'qc_line' else 'fa-cog' }}"></i>
                                {{ u.role.replace('_', ' ').title() }}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge status-{{ 'active' if u.is_active else 'inactive' }}">
                                <i class="fas {{ 'fa-check-circle' if u.is_active else 'fa-times-circle' }}"></i>
                                {{ 'Active' if u.is_active else 'Inactive' }}
                            </span>
                        </td>
                        <td>{{ u.last_login.strftime('%d/%m/%Y %H:%M') if u.last_login else 'Never' }}</td>
                        <td>{{ u.created_at.strftime('%d/%m/%Y') if u.created_at else '-' }}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-outline"
                                    onclick="editUser({{ u.id }}, '{{ u.username }}', '{{ u.email }}', '{{ u.full_name }}', '{{ u.role }}', {{ 'true' if u.is_active else 'false' }})"
                                    title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                {% if u.id != current_user.id %}
                                <button
                                    class="btn btn-sm btn-outline {{ 'text-danger' if u.is_active else 'text-success' }}"
                                    onclick="toggleUserStatus({{ u.id }}, {{ 'false' if u.is_active else 'true' }})"
                                    title="{{ 'Deactivate' if u.is_active else 'Activate' }}">
                                    <i class="fas {{ 'fa-user-slash' if u.is_active else 'fa-user-check' }}"></i>
                                </button>
                                <button class="btn btn-sm btn-outline"
                                    onclick="resetPassword({{ u.id }}, '{{ u.username }}')" title="Reset Password">
                                    <i class="fas fa-key"></i>
                                </button>
                                <a href="{{ url_for('views.user_permissions', user_id=u.id) }}"
                                    class="btn btn-sm btn-outline" title="Manage Permissions">
                                    <i class="fas fa-shield-alt"></i>
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <div class="empty-state-icon"><i class="fas fa-users"></i></div>
                                <div class="empty-state-title">Belum ada user</div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if users.pages > 1 %}
        <div class="pagination">
            {% if users.has_prev %}
            <a href="?page={{ users.prev_num }}" class="page-link"><i class="fas fa-chevron-left"></i></a>
            {% endif %}
            {% for page_num in users.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
            {% if page_num %}
            <a href="?page={{ page_num }}" class="page-link {% if page_num == users.page %}active{% endif %}">{{
                page_num }}</a>
            {% else %}
            <span class="page-link disabled">...</span>
            {% endif %}
            {% endfor %}
            {% if users.has_next %}
            <a href="?page={{ users.next_num }}" class="page-link"><i class="fas fa-chevron-right"></i></a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- New User Modal -->
<div class="modal-backdrop" id="newUserModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-user-plus"></i> Tambah User Baru</h3>
            <button class="modal-close" onclick="closeModal('newUserModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="newUserForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Username *</label>
                        <input type="text" class="form-input" name="username" required placeholder="username">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-input" name="email" required placeholder="email@example.com">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" class="form-input" name="full_name" required placeholder="Nama Lengkap">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Password *</label>
                        <input type="password" class="form-input" name="password" required
                            placeholder="Min. 6 karakter">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role *</label>
                        <select class="form-select" name="role" required>
                            <option value="operator">Operator</option>
                            <option value="qc_line">QC Line</option>
                            <option value="admin_produksi">Admin Produksi</option>
                            <option value="owner">Owner</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="create_employee" checked>
                        <span>Buat profil Employee untuk user ini</span>
                    </label>
                    <small class="text-muted">Employee profile diperlukan untuk assign ke production tasks</small>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('newUserModal')">Batal</button>
            <button class="btn btn-primary" onclick="saveNewUser()">
                <i class="fas fa-save"></i> Simpan
            </button>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal-backdrop" id="editUserModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-user-edit"></i> Edit User</h3>
            <button class="modal-close" onclick="closeModal('editUserModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editUserForm">
                <input type="hidden" name="user_id" id="editUserId">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Username *</label>
                        <input type="text" class="form-input" name="username" id="editUsername" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-input" name="email" id="editEmail" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" class="form-input" name="full_name" id="editFullName" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Role *</label>
                        <select class="form-select" name="role" id="editRole" required>
                            <option value="operator">Operator</option>
                            <option value="qc_line">QC Line</option>
                            <option value="admin_produksi">Admin Produksi</option>
                            <option value="owner">Owner</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="is_active" id="editStatus">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('editUserModal')">Batal</button>
            <button class="btn btn-primary" onclick="saveEditUser()">
                <i class="fas fa-save"></i> Update
            </button>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal-backdrop" id="resetPasswordModal">
    <div class="modal modal-sm">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-key"></i> Reset Password</h3>
            <button class="modal-close" onclick="closeModal('resetPasswordModal')">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="resetUserId">
            <p>Reset password untuk user: <strong id="resetUsername"></strong></p>
            <div class="form-group">
                <label class="form-label">Password Baru *</label>
                <input type="password" class="form-input" id="newPasswordInput" placeholder="Min. 6 karakter">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('resetPasswordModal')">Batal</button>
            <button class="btn btn-primary" onclick="confirmResetPassword()">
                <i class="fas fa-check"></i> Reset
            </button>
        </div>
    </div>
</div>

<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
    }

    .stat-card {
        background: var(--white);
        border-radius: var(--radius-lg);
        padding: 1.25rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        border: 1px solid var(--gray-200);
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--gray-100);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--gray-500);
        font-size: 1.25rem;
    }

    .stat-icon.active {
        background: #D1FAE5;
        color: #059669;
    }

    .stat-icon.admin {
        background: #DBEAFE;
        color: #1E40AF;
    }

    .stat-icon.operator {
        background: #FEF3C7;
        color: #D97706;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--gray-800);
    }

    .stat-label {
        font-size: 0.85rem;
        color: var(--gray-500);
    }

    .filters-row {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .filter-group {
        min-width: 150px;
    }

    .filter-group.search-group {
        flex: 1;
        min-width: 250px;
        position: relative;
    }

    .search-group i {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray-400);
    }

    .search-group input {
        padding-left: 2.5rem;
    }

    .user-cell {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .user-name {
        font-weight: 600;
        color: var(--gray-800);
    }

    .user-username {
        font-size: 0.8rem;
        color: var(--gray-500);
    }

    .role-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .role-admin {
        background: #DBEAFE;
        color: #1E40AF;
    }

    .role-owner {
        background: #F3E8FF;
        color: #7C3AED;
    }

    .role-admin_produksi {
        background: #FEF3C7;
        color: #D97706;
    }

    .role-qc_line {
        background: #D1FAE5;
        color: #059669;
    }

    .role-operator {
        background: #F3F4F6;
        color: #374151;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.625rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .status-active {
        background: #D1FAE5;
        color: #059669;
    }

    .status-inactive {
        background: #FEE2E2;
        color: #DC2626;
    }

    .action-buttons {
        display: flex;
        gap: 0.375rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }

    .checkbox-label input {
        width: 18px;
        height: 18px;
    }

    .modal-sm {
        max-width: 400px;
    }

    @media (max-width: 1024px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }

        .filters-row {
            flex-direction: column;
        }

        .filter-group {
            width: 100%;
        }

        .form-row {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        calculateStats();
        setupFilters();
    });

    function calculateStats() {
        const rows = document.querySelectorAll('#usersTable tbody tr[data-id]');
        let active = 0, admins = 0, operators = 0;

        rows.forEach(row => {
            if (row.dataset.status === 'active') active++;
            if (row.dataset.role === 'admin' || row.dataset.role === 'owner') admins++;
            if (row.dataset.role === 'operator') operators++;
        });

        document.getElementById('activeUsers').textContent = active;
        document.getElementById('adminCount').textContent = admins;
        document.getElementById('operatorCount').textContent = operators;
    }

    function setupFilters() {
        const searchInput = document.getElementById('searchInput');
        const roleFilter = document.getElementById('roleFilter');
        const statusFilter = document.getElementById('statusFilter');

        const filterRows = () => {
            const search = searchInput.value.toLowerCase();
            const role = roleFilter.value;
            const status = statusFilter.value;

            document.querySelectorAll('#usersTable tbody tr[data-id]').forEach(row => {
                const text = row.textContent.toLowerCase();
                const matchesSearch = !search || text.includes(search);
                const matchesRole = !role || row.dataset.role === role;
                const matchesStatus = !status || row.dataset.status === status;

                row.style.display = (matchesSearch && matchesRole && matchesStatus) ? '' : 'none';
            });
        };

        searchInput.addEventListener('input', debounce(filterRows, 300));
        roleFilter.addEventListener('change', filterRows);
        statusFilter.addEventListener('change', filterRows);
    }

    function openNewUserModal() {
        document.getElementById('newUserForm').reset();
        openModal('newUserModal');
    }

    async function saveNewUser() {
        const form = document.getElementById('newUserForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        data.create_employee = formData.get('create_employee') === 'on';

        if (!data.email || !data.username || !data.full_name || !data.password) {
            showToast('Lengkapi semua field wajib', 'error');
            return;
        }

        if (data.password.length < 6) {
            showToast('Password minimal 6 karakter', 'error');
            return;
        }

        try {
            await api.post('/users', data);
            showToast('User berhasil dibuat!', 'success');
            closeModal('newUserModal');
            location.reload();
        } catch (e) {
            showToast(e.message || 'Gagal membuat user', 'error');
        }
    }

    function editUser(id, username, email, fullName, role, isActive) {
        document.getElementById('editUserId').value = id;
        document.getElementById('editUsername').value = username;
        document.getElementById('editEmail').value = email;
        document.getElementById('editFullName').value = fullName;
        document.getElementById('editRole').value = role;
        document.getElementById('editStatus').value = isActive ? 'true' : 'false';
        openModal('editUserModal');
    }

    async function saveEditUser() {
        const userId = document.getElementById('editUserId').value;
        const data = {
            username: document.getElementById('editUsername').value,
            email: document.getElementById('editEmail').value,
            full_name: document.getElementById('editFullName').value,
            role: document.getElementById('editRole').value,
            is_active: document.getElementById('editStatus').value === 'true'
        };

        try {
            await api.put('/users/' + userId, data);
            showToast('User berhasil diupdate!', 'success');
            closeModal('editUserModal');
            location.reload();
        } catch (e) {
            showToast(e.message || 'Gagal update user', 'error');
        }
    }

    async function toggleUserStatus(userId, activate) {
        const action = activate ? 'mengaktifkan' : 'menonaktifkan';
        if (!confirm(`Yakin ingin ${action} user ini?`)) return;

        try {
            await api.put('/users/' + userId, { is_active: activate });
            showToast('Status user berhasil diubah', 'success');
            location.reload();
        } catch (e) {
            showToast(e.message || 'Gagal mengubah status', 'error');
        }
    }

    function resetPassword(userId, username) {
        document.getElementById('resetUserId').value = userId;
        document.getElementById('resetUsername').textContent = username;
        document.getElementById('newPasswordInput').value = '';
        openModal('resetPasswordModal');
    }

    async function confirmResetPassword() {
        const userId = document.getElementById('resetUserId').value;
        const newPassword = document.getElementById('newPasswordInput').value;

        if (!newPassword || newPassword.length < 6) {
            showToast('Password minimal 6 karakter', 'error');
            return;
        }

        try {
            await api.put('/users/' + userId, { password: newPassword });
            showToast('Password berhasil direset!', 'success');
            closeModal('resetPasswordModal');
        } catch (e) {
            showToast(e.message || 'Gagal reset password', 'error');
        }
    }
</script>
{% endblock %}