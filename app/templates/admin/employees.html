{% extends "base.html" %}
{% block title %}Employees{% endblock %}
{% block page_title %}Employee Management{% endblock %}

{% block content %}
<div class="page-header mb-4">
    <p class="text-muted">Kelola data karyawan</p>
    <button class="btn btn-primary" onclick="openModal('newEmployeeModal')"><i
            class="fas fa-plus margin-right: 8px;"></i> Tambah
        Employee</button>
</div>

<style>
    .badge i {
        margin-right: 6px;
    }
</style>

<div class="card">
    <div class="card-body">
        <!-- Search and Filter -->
        <div class="filters-row mb-3">
            <div class="filter-group search-group">
                <i class="fas fa-search"></i>
                <input type="text" class="form-input" id="searchInput" placeholder="Cari kode, nama, atau phone...">
            </div>
            <div class="filter-group">
                <select class="form-select" id="positionFilter">
                    <option value="">Semua Posisi</option>
                    <option value="owner">Owner</option>
                    <option value="admin">Admin</option>
                    <option value="qc_line">QC Line</option>
                    <option value="sewing">Sewing</option>
                    <option value="sablon">Sablon</option>
                    <option value="cutting">Cutting</option>
                    <option value="finishing">Finishing</option>
                    <option value="packing">Packing</option>
                </select>
            </div>
            <div class="filter-group">
                <select class="form-select" id="empTypeFilter">
                    <option value="">Semua Status Pekerja</option>
                    <option value="karyawan">Karyawan</option>
                    <option value="harian_lepas">Harian Lepas</option>
                    <option value="borongan">Borongan</option>
                    <option value="magang">Magang</option>
                </select>
            </div>
            <div class="filter-group">
                <select class="form-select" id="statusFilter">
                    <option value="">Semua Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
        </div>

        <div class="table-container">
            <table class="table" id="employeesTable">
                <thead>
                    <tr>
                        <th>Kode</th>
                        <th>Nama</th>
                        <th>Posisi / Stasiun Kerja</th>
                        <th>Status Pekerja</th>
                        <th>Phone</th>
                        <th>Login</th>
                        <th>Status</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for e in employees.items %}
                    <tr data-code="{{ e.employee_code|lower }}" data-name="{{ e.name|lower }}"
                        data-position="{{ e.position or '' }}" data-emptype="{{ e.employment_type or 'karyawan' }}"
                        data-phone="{{ e.phone or '' }}" data-status="{{ 'active' if e.is_active else 'inactive' }}">
                        <td><strong>{{ e.employee_code }}</strong></td>
                        <td>{{ e.name }}</td>
                        <td>
                            {% set positions = (e.position or '-').split(',') %}
                            {% for pos in positions %}
                            {% set pos = pos.strip() %}
                            {% if pos == 'owner' %}
                            <span class="badge mb-1"
                                style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;"><i
                                    class="fas fa-crown"></i> Owner</span>
                            {% elif pos == 'admin' %}
                            <span class="badge mb-1"
                                style="background: linear-gradient(135deg, #11998e, #38ef7d); color: white;"><i
                                    class="fas fa-user-shield"></i> Admin</span>
                            {% elif pos == 'qc_line' %}
                            <span class="badge mb-1"
                                style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white;"><i
                                    class="fas fa-clipboard-check"></i> QC Line</span>
                            {% elif pos == 'sewing' %}
                            <span class="badge mb-1"
                                style="background: linear-gradient(135deg, #4facfe, #00f2fe); color: white;"><i
                                    class="fas fa-tshirt"></i> Sewing</span>
                            {% elif pos == 'sablon' %}
                            <span class="badge mb-1"
                                style="background: linear-gradient(135deg, #fa709a, #fee140); color: white;"><i
                                    class="fas fa-paint-brush"></i> Sablon</span>
                            {% elif pos == 'cutting' %}
                            <span class="badge mb-1"
                                style="background: linear-gradient(135deg, #a8edea, #fed6e3); color: #333;"><i
                                    class="fas fa-cut"></i> Cutting</span>
                            {% elif pos == 'finishing' %}
                            <span class="badge mb-1"
                                style="background: linear-gradient(135deg, #d299c2, #fef9d7); color: #333;"><i
                                    class="fas fa-magic"></i> Finishing</span>
                            {% elif pos == 'packing' %}
                            <span class="badge mb-1"
                                style="background: linear-gradient(135deg, #89f7fe, #66a6ff); color: white;"><i
                                    class="fas fa-box"></i> Packing</span>
                            {% elif pos != '-' %}
                            <span class="badge badge-secondary mb-1">{{ pos }}</span>
                            {% else %}
                            <span class="badge badge-secondary">-</span>
                            {% endif %}
                            {% endfor %}
                        </td>
                        <td>
                            {% set emp_type = e.employment_type or 'karyawan' %}
                            {% if emp_type == 'karyawan' %}
                            <span class="badge" style="background: #28a745; color: white;"><i
                                    class="fas fa-id-badge"></i> Karyawan</span>
                            {% elif emp_type == 'harian_lepas' %}
                            <span class="badge" style="background: #17a2b8; color: white;"><i
                                    class="fas fa-calendar-day"></i> Harian Lepas</span>
                            {% elif emp_type == 'borongan' %}
                            <span class="badge" style="background: #fd7e14; color: white;"><i class="fas fa-tasks"></i>
                                Borongan</span>
                            {% elif emp_type == 'magang' %}
                            <span class="badge" style="background: #6f42c1; color: white;"><i
                                    class="fas fa-graduation-cap"></i> Magang</span>
                            {% else %}
                            <span class="badge badge-secondary">{{ emp_type }}</span>
                            {% endif %}
                        </td>
                        <td>{{ e.phone or '-' }}</td>
                        <td>
                            {% if e.user %}
                            <span class="badge badge-success"><i class="fas fa-check"></i> {{ e.user.username }}</span>
                            {% else %}
                            <span class="badge badge-secondary">-</span>
                            {% endif %}
                        </td>
                        <td><span class="badge badge-{{ 'success' if e.is_active else 'secondary' }}">{{ 'Active' if
                                e.is_active else 'Inactive' }}</span></td>
                        <td>
                            <div class="action-buttons" style="display: flex; gap: 0.25rem;">
                                <a href="{{ url_for('views.employee_detail', employee_id=e.id) }}"
                                    class="btn btn-sm btn-outline-primary" title="Lihat Detail">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button class="btn btn-sm btn-outline" onclick="editEmployee({{ e.id }})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted">Tidak ada employee</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit Employee Modal -->
<div class="modal-backdrop" id="newEmployeeModal">
    <div class="modal" style="max-width: 550px;">
        <div class="modal-header">
            <h3 class="modal-title" id="employeeModalTitle">Tambah Employee</h3>
            <button class="modal-close" onclick="closeModal('newEmployeeModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="employeeForm">
                <input type="hidden" name="id" id="employeeId">

                <!-- Basic Info Section -->
                <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin-bottom: 1rem; color: var(--primary);"><i class="fas fa-user"></i> Informasi
                        Karyawan</h4>
                    <div class="form-group">
                        <label class="form-label">Nama Lengkap *</label>
                        <input type="text" class="form-input" name="name" id="empName" required
                            placeholder="Masukkan nama lengkap">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Posisi / Stasiun Kerja * <small style="color: var(--gray-500);">(pilih
                                satu atau lebih)</small></label>
                        <div class="position-grid" id="positionGrid">
                            <label class="position-card" data-value="owner">
                                <input type="checkbox" name="positions" value="owner">
                                <div class="position-icon"
                                    style="background: linear-gradient(135deg, #667eea, #764ba2);"><i
                                        class="fas fa-crown"></i></div>
                                <span>Owner</span>
                            </label>
                            <label class="position-card" data-value="admin">
                                <input type="checkbox" name="positions" value="admin">
                                <div class="position-icon"
                                    style="background: linear-gradient(135deg, #11998e, #38ef7d);"><i
                                        class="fas fa-user-shield"></i></div>
                                <span>Admin</span>
                            </label>
                            <label class="position-card" data-value="qc_line">
                                <input type="checkbox" name="positions" value="qc_line">
                                <div class="position-icon"
                                    style="background: linear-gradient(135deg, #f093fb, #f5576c);"><i
                                        class="fas fa-clipboard-check"></i></div>
                                <span>QC Line</span>
                            </label>
                            <label class="position-card" data-value="sewing">
                                <input type="checkbox" name="positions" value="sewing">
                                <div class="position-icon"
                                    style="background: linear-gradient(135deg, #4facfe, #00f2fe);"><i
                                        class="fas fa-tshirt"></i></div>
                                <span>Sewing</span>
                            </label>
                            <label class="position-card" data-value="sablon">
                                <input type="checkbox" name="positions" value="sablon">
                                <div class="position-icon"
                                    style="background: linear-gradient(135deg, #fa709a, #fee140);"><i
                                        class="fas fa-paint-brush"></i></div>
                                <span>Sablon</span>
                            </label>
                            <label class="position-card" data-value="cutting">
                                <input type="checkbox" name="positions" value="cutting">
                                <div class="position-icon"
                                    style="background: linear-gradient(135deg, #a8edea, #fed6e3);"><i
                                        class="fas fa-cut"></i></div>
                                <span>Cutting</span>
                            </label>
                            <label class="position-card" data-value="finishing">
                                <input type="checkbox" name="positions" value="finishing">
                                <div class="position-icon"
                                    style="background: linear-gradient(135deg, #d299c2, #fef9d7);"><i
                                        class="fas fa-magic"></i></div>
                                <span>Finishing</span>
                            </label>
                            <label class="position-card" data-value="packing">
                                <input type="checkbox" name="positions" value="packing">
                                <div class="position-icon"
                                    style="background: linear-gradient(135deg, #89f7fe, #66a6ff);"><i
                                        class="fas fa-box"></i></div>
                                <span>Packing</span>
                            </label>
                        </div>
                    </div>

                    <!-- Employment Type / Status Pekerja -->
                    <div class="form-group">
                        <label class="form-label">Status Pekerja *</label>
                        <div class="employment-grid" id="employmentGrid">
                            <label class="employment-card" data-value="karyawan">
                                <input type="radio" name="employment_type" value="karyawan" checked>
                                <div class="employment-icon" style="background: #28a745;"><i
                                        class="fas fa-id-badge"></i></div>
                                <span>Karyawan</span>
                                <small>Tetap</small>
                            </label>
                            <label class="employment-card" data-value="harian_lepas">
                                <input type="radio" name="employment_type" value="harian_lepas">
                                <div class="employment-icon" style="background: #17a2b8;"><i
                                        class="fas fa-calendar-day"></i></div>
                                <span>Harian Lepas</span>
                                <small>Per Hari</small>
                            </label>
                            <label class="employment-card" data-value="borongan">
                                <input type="radio" name="employment_type" value="borongan">
                                <div class="employment-icon" style="background: #fd7e14;"><i class="fas fa-tasks"></i>
                                </div>
                                <span>Borongan</span>
                                <small>Per Proyek</small>
                            </label>
                            <label class="employment-card" data-value="magang">
                                <input type="radio" name="employment_type" value="magang">
                                <div class="employment-icon" style="background: #6f42c1;"><i
                                        class="fas fa-graduation-cap"></i></div>
                                <span>Magang</span>
                                <small>Intern</small>
                            </label>
                        </div>
                    </div>

                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">No. Telepon</label>
                            <input type="text" class="form-input" name="phone" id="empPhone" placeholder="08xxxxxxxxxx">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" name="email" id="empEmail"
                                placeholder="email@example.com">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tanggal Bergabung</label>
                        <input type="date" class="form-input" name="join_date" id="empJoinDate">
                    </div>

                    <!-- Status Aktif (only visible when editing) -->
                    <div class="form-group" id="statusActiveSection" style="display: none;">
                        <label class="form-label">Status Karyawan</label>
                        <div
                            style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: var(--gray-50); border-radius: 8px;">
                            <label class="switch"
                                style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin: 0;">
                                <input type="checkbox" id="empIsActive" name="is_active" checked>
                                <span class="slider"></span>
                            </label>
                            <div>
                                <span id="statusLabel" style="font-weight: 600; color: #10B981;">Aktif</span>
                                <small style="display: block; color: var(--gray-500); font-size: 0.75rem;">
                                    Karyawan dapat ditugaskan ke produksi
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Login Account Section -->
                <div
                    style="background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.1), rgba(var(--accent-rgb), 0.1)); padding: 1rem; border-radius: 8px; border: 1px solid var(--primary);">
                    <div
                        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                        <h4 style="margin: 0; color: var(--primary);"><i class="fas fa-key"></i> Akun Login</h4>
                        <label class="switch" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="createLoginCheckbox" onchange="toggleLoginFields()">
                            <span class="slider"></span>
                            <span style="font-size: 0.85rem;">Buat Akun Login</span>
                        </label>
                    </div>

                    <div id="loginFields" style="display: none;">
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Username *</label>
                                <input type="text" class="form-input" name="username" id="empUsername"
                                    placeholder="username untuk login">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password *</label>
                                <div style="position: relative;">
                                    <input type="password" class="form-input" name="password" id="empPassword"
                                        placeholder="Min. 6 karakter" style="padding-right: 40px;">
                                    <button type="button" onclick="togglePassword()"
                                        style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-secondary);">
                                        <i class="fas fa-eye" id="togglePwdIcon"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Role Sistem *</label>
                            <select class="form-input" name="role" id="empRole">
                                <option value="operator">Operator (Akses Terbatas)</option>
                                <option value="qc_line">QC Line</option>
                                <option value="admin_produksi">Admin Produksi</option>
                                <option value="owner">Owner</option>
                                <option value="admin">Admin (Full Access)</option>
                            </select>
                        </div>
                        <div
                            style="background: rgba(255, 193, 7, 0.15); padding: 0.75rem; border-radius: 6px; border-left: 3px solid #ffc107;">
                            <small style="color: var(--text-secondary);">
                                <i class="fas fa-info-circle"></i> Password default: <strong>password123</strong> jika
                                tidak diisi.
                            </small>
                        </div>
                    </div>

                    <div id="noLoginMessage" style="color: var(--text-secondary); font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i> Aktifkan toggle di atas untuk membuat akun login bagi
                        karyawan ini.
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('newEmployeeModal')">Batal</button>
            <button class="btn btn-primary" onclick="saveEmployee()"><i class="fas fa-save"></i> Simpan</button>
        </div>
    </div>
</div>

<!-- Work History Modal -->
<div class="modal-backdrop" id="historyModal">
    <div class="modal" style="max-width: 750px;">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-history"></i> Riwayat Pekerjaan</h3>
            <button class="modal-close" onclick="closeModal('historyModal')">&times;</button>
        </div>
        <div class="modal-body" id="historyContent" style="max-height: 500px; overflow-y: auto;">
            <div class="text-center p-4"><i class="fas fa-spinner fa-spin"></i> Memuat...</div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('historyModal')">Tutup</button>
        </div>
    </div>
</div>

<style>
    /* Filter Styles */
    .filters-row {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .filter-group {
        min-width: 150px;
    }

    .filter-group.search-group {
        flex: 1;
        min-width: 250px;
        position: relative;
    }

    .search-group i {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray-400);
    }

    .search-group input {
        padding-left: 2.5rem;
    }

    /* Position Grid */
    .position-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.75rem;
        margin-top: 0.5rem;
    }

    .position-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0.75rem 0.5rem;
        border: 2px solid var(--gray-300);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: var(--bg-primary);
        position: relative;
    }

    .position-card:hover {
        border-color: var(--gray-500);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .position-card input {
        display: none;
    }

    .position-card.selected {
        border-color: #1a1a1a;
        background: #f8f9fa;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
    }

    /* Checkmark indicator for position cards */
    .position-card::after {
        content: '';
        position: absolute;
        top: 6px;
        right: 6px;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 2px solid var(--gray-300);
        background: white;
        transition: all 0.2s ease;
        pointer-events: none;
    }

    .position-card.selected::after {
        content: '✓';
        background: #10B981;
        border-color: #10B981;
        color: white;
        font-size: 11px;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .position-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
    }

    .position-card span {
        font-size: 0.8rem;
        font-weight: 500;
        text-align: center;
        color: var(--gray-600);
    }

    .position-card.selected span {
        color: #1a1a1a;
        font-weight: 600;
    }

    /* Employment Type Grid */
    .employment-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.75rem;
        margin-top: 0.5rem;
    }

    .employment-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0.6rem 0.4rem;
        border: 2px solid var(--gray-300);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: var(--bg-primary);
        position: relative;
    }

    .employment-card:hover {
        border-color: var(--gray-500);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .employment-card input {
        display: none;
    }

    .employment-card.selected {
        border-color: #1a1a1a;
        background: #f8f9fa;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
    }

    /* Radio indicator for employment cards */
    .employment-card::after {
        content: '';
        position: absolute;
        top: 6px;
        right: 6px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 2px solid var(--gray-300);
        background: white;
        transition: all 0.2s ease;
        pointer-events: none;
    }

    .employment-card.selected::after {
        background: #10B981;
        border-color: #10B981;
        box-shadow: inset 0 0 0 3px white;
    }

    .employment-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1rem;
        margin-bottom: 0.4rem;
    }

    .employment-card span {
        font-size: 0.75rem;
        font-weight: 600;
        text-align: center;
        color: var(--gray-600);
    }

    .employment-card.selected span {
        color: #1a1a1a;
    }

    .employment-card small {
        font-size: 0.65rem;
        color: var(--gray-400);
        margin-top: 2px;
    }

    .employment-card.selected small {
        color: var(--gray-600);
    }

    /* Toggle Switch */
    .switch {
        position: relative;
        display: inline-block;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        width: 44px;
        height: 24px;
        background-color: var(--border-color);
        border-radius: 24px;
        position: relative;
        transition: 0.3s;
        display: inline-block;
    }

    .slider:before {
        content: "";
        position: absolute;
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        border-radius: 50%;
        transition: 0.3s;
    }

    .switch input:checked+.slider {
        background-color: var(--primary);
    }

    .switch input:checked+.slider:before {
        transform: translateX(20px);
    }

    .form-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.15);
    }

    @media (max-width: 600px) {
        .position-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .employment-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>

<script>
    let editingEmployeeId = null;

    // Setup filters on page load
    document.addEventListener('DOMContentLoaded', function () {
        setupEmployeeFilters();
    });

    function debounce(func, wait) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    function setupEmployeeFilters() {
        const searchInput = document.getElementById('searchInput');
        const positionFilter = document.getElementById('positionFilter');
        const empTypeFilter = document.getElementById('empTypeFilter');
        const statusFilter = document.getElementById('statusFilter');

        const filterRows = () => {
            const search = searchInput.value.toLowerCase();
            const position = positionFilter.value;
            const empType = empTypeFilter.value;
            const status = statusFilter.value;

            document.querySelectorAll('#employeesTable tbody tr[data-name]').forEach(row => {
                const code = row.dataset.code || '';
                const name = row.dataset.name || '';
                const rowPosition = row.dataset.position || '';
                const rowEmpType = row.dataset.emptype || '';
                const phone = row.dataset.phone || '';
                const rowStatus = row.dataset.status || '';

                const matchesSearch = !search ||
                    code.includes(search) ||
                    name.includes(search) ||
                    phone.includes(search);
                const matchesPosition = !position || rowPosition.includes(position);
                const matchesEmpType = !empType || rowEmpType === empType;
                const matchesStatus = !status || rowStatus === status;

                row.style.display = (matchesSearch && matchesPosition && matchesEmpType && matchesStatus) ? '' : 'none';
            });
        };

        searchInput.addEventListener('input', debounce(filterRows, 300));
        positionFilter.addEventListener('change', filterRows);
        empTypeFilter.addEventListener('change', filterRows);
        statusFilter.addEventListener('change', filterRows);
    }

    // Position card selection (multi-select with checkboxes)
    document.querySelectorAll('.position-card').forEach(card => {
        card.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();

            const checkbox = this.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;

            // Update visual selection
            if (checkbox.checked) {
                this.classList.add('selected');
            } else {
                this.classList.remove('selected');
            }

            // Auto-set role based on highest priority position
            if (document.getElementById('createLoginCheckbox').checked) {
                const selectedPositions = Array.from(document.querySelectorAll('.position-card.selected'))
                    .map(c => c.dataset.value);

                // Priority: owner > admin > qc_line > operator
                let role = 'operator';
                if (selectedPositions.includes('owner')) role = 'owner';
                else if (selectedPositions.includes('admin')) role = 'admin';
                else if (selectedPositions.includes('qc_line')) role = 'qc_line';
                else if (selectedPositions.includes('sewing') || selectedPositions.includes('cutting')
                    || selectedPositions.includes('finishing') || selectedPositions.includes('sablon')
                    || selectedPositions.includes('packing')) role = 'operator';

                document.getElementById('empRole').value = role;
            }
        });
    });

    // Employment type card selection
    document.querySelectorAll('.employment-card').forEach(card => {
        card.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();

            document.querySelectorAll('.employment-card').forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
            this.querySelector('input').checked = true;
        });
    });

    // Set default employment type selection
    document.querySelector('.employment-card[data-value="karyawan"]')?.classList.add('selected');

    function toggleLoginFields() {
        const checkbox = document.getElementById('createLoginCheckbox');
        const loginFields = document.getElementById('loginFields');
        const noLoginMessage = document.getElementById('noLoginMessage');

        if (checkbox.checked) {
            loginFields.style.display = 'block';
            noLoginMessage.style.display = 'none';
            // Auto-generate username from name
            const name = document.getElementById('empName').value;
            if (name && !document.getElementById('empUsername').value) {
                document.getElementById('empUsername').value = name.toLowerCase().replace(/\s+/g, '.').replace(/[^a-z.]/g, '');
            }
            // Auto-set role based on selected position
            const selectedPos = document.querySelector('.position-card.selected');
            if (selectedPos) {
                const roleMap = {
                    'owner': 'owner',
                    'admin': 'admin',
                    'qc_line': 'qc_line',
                    'sewing': 'operator',
                    'sablon': 'operator',
                    'cutting': 'operator',
                    'finishing': 'operator',
                    'packing': 'operator'
                };
                document.getElementById('empRole').value = roleMap[selectedPos.dataset.value] || 'operator';
            }
        } else {
            loginFields.style.display = 'none';
            noLoginMessage.style.display = 'block';
        }
    }

    function togglePassword() {
        const pwdField = document.getElementById('empPassword');
        const icon = document.getElementById('togglePwdIcon');
        if (pwdField.type === 'password') {
            pwdField.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            pwdField.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    // Auto-generate username when name changes
    document.getElementById('empName').addEventListener('input', function () {
        if (document.getElementById('createLoginCheckbox').checked) {
            const username = this.value.toLowerCase().replace(/\s+/g, '.').replace(/[^a-z.]/g, '');
            if (!editingEmployeeId) {
                document.getElementById('empUsername').value = username;
            }
        }
    });

    function resetForm() {
        document.getElementById('employeeForm').reset();
        document.getElementById('employeeId').value = '';
        document.getElementById('createLoginCheckbox').checked = false;

        // Clear all position cards - both visual and checkbox state
        document.querySelectorAll('.position-card').forEach(c => {
            c.classList.remove('selected');
            c.querySelector('input[type="checkbox"]').checked = false;
        });

        // Clear all employment cards
        document.querySelectorAll('.employment-card').forEach(c => c.classList.remove('selected'));

        // Set default employment type
        const defaultEmpCard = document.querySelector('.employment-card[data-value="karyawan"]');
        if (defaultEmpCard) {
            defaultEmpCard.classList.add('selected');
            defaultEmpCard.querySelector('input').checked = true;
        }

        // Reset is_active to checked (active) and hide section
        const isActiveCheckbox = document.getElementById('empIsActive');
        if (isActiveCheckbox) {
            isActiveCheckbox.checked = true;
        }
        document.getElementById('statusActiveSection').style.display = 'none';

        // Hide login fields
        const loginFields = document.getElementById('loginFields');
        const noLoginMessage = document.getElementById('noLoginMessage');
        if (loginFields) loginFields.style.display = 'none';
        if (noLoginMessage) noLoginMessage.style.display = 'block';

        editingEmployeeId = null;
        document.getElementById('employeeModalTitle').textContent = 'Tambah Employee';
    }

    function updateStatusLabel() {
        const isActiveCheckbox = document.getElementById('empIsActive');
        const statusLabel = document.getElementById('statusLabel');
        if (isActiveCheckbox && statusLabel) {
            if (isActiveCheckbox.checked) {
                statusLabel.textContent = 'Aktif';
                statusLabel.style.color = '#10B981';
            } else {
                statusLabel.textContent = 'Tidak Aktif';
                statusLabel.style.color = '#EF4444';
            }
        }
    }

    // Add event listener for status toggle
    document.getElementById('empIsActive')?.addEventListener('change', updateStatusLabel);

    function openModal(id) {
        resetForm();
        document.getElementById(id).classList.add('active');
    }

    function editEmployee(id) {
        resetForm(); // Reset form first before populating with edit data
        editingEmployeeId = id;
        document.getElementById('employeeModalTitle').textContent = 'Edit Employee';

        // Show status section when editing
        document.getElementById('statusActiveSection').style.display = 'block';

        fetch(`/api/employees/${id}`)
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    const e = res.data;
                    document.getElementById('employeeId').value = e.id;
                    document.getElementById('empName').value = e.name || '';
                    document.getElementById('empPhone').value = e.phone || '';
                    document.getElementById('empEmail').value = e.email || '';
                    document.getElementById('empJoinDate').value = e.join_date || '';

                    // Set is_active status
                    const isActiveCheckbox = document.getElementById('empIsActive');
                    const statusLabel = document.getElementById('statusLabel');
                    if (isActiveCheckbox) {
                        isActiveCheckbox.checked = e.is_active !== false;
                        updateStatusLabel();
                    }

                    // Select position cards (multiple positions stored as comma-separated)
                    if (e.position) {
                        const positions = e.position.split(',').map(p => p.trim());
                        positions.forEach(pos => {
                            const card = document.querySelector(`.position-card[data-value="${pos}"]`);
                            if (card) {
                                card.classList.add('selected');
                                card.querySelector('input[type="checkbox"]').checked = true;
                            }
                        });
                    }

                    // Select employment type card
                    document.querySelectorAll('.employment-card').forEach(c => c.classList.remove('selected'));
                    const empType = e.employment_type || 'karyawan';
                    const empCard = document.querySelector(`.employment-card[data-value="${empType}"]`);
                    if (empCard) {
                        empCard.classList.add('selected');
                        empCard.querySelector('input').checked = true;
                    }

                    if (e.user_id) {
                        document.getElementById('createLoginCheckbox').checked = true;
                        document.getElementById('empUsername').value = e.username || '';
                        document.getElementById('empRole').value = e.role || 'operator';
                        toggleLoginFields();
                    }

                    document.getElementById('newEmployeeModal').classList.add('active');
                }
            })
            .catch(err => showToast('Gagal memuat data', 'error'));
    }

    async function saveEmployee() {
        const form = document.getElementById('employeeForm');
        const formData = new FormData(form);

        // Build data object manually to handle multiple positions
        const data = {
            id: formData.get('id'),
            name: formData.get('name'),
            phone: formData.get('phone'),
            email: formData.get('email'),
            join_date: formData.get('join_date'),
            employment_type: formData.get('employment_type'),
            username: formData.get('username'),
            password: formData.get('password'),
            role: formData.get('role'),
            is_active: document.getElementById('empIsActive')?.checked ?? true
        };

        // Collect all selected positions
        const selectedPositions = Array.from(document.querySelectorAll('input[name="positions"]:checked'))
            .map(cb => cb.value);
        data.position = selectedPositions.join(','); // Store as comma-separated string

        // Validation
        if (!data.name) { showToast('Nama wajib diisi', 'error'); return; }
        if (selectedPositions.length === 0) { showToast('Pilih minimal satu posisi/stasiun kerja', 'error'); return; }

        const createLogin = document.getElementById('createLoginCheckbox').checked;
        data.create_login = createLogin;

        if (createLogin) {
            if (!data.username) { showToast('Username wajib diisi untuk membuat akun', 'error'); return; }
            if (!data.password) {
                data.password = 'password123'; // Default password
            } else if (data.password.length < 6) {
                showToast('Password minimal 6 karakter', 'error');
                return;
            }
        }

        try {
            const isEdit = !!data.id;
            const url = isEdit ? `/api/employees/${data.id}` : '/api/employees';
            const method = isEdit ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                showToast(isEdit ? 'Employee berhasil diupdate' : 'Employee berhasil ditambahkan', 'success');
                closeModal('newEmployeeModal');
                setTimeout(() => location.reload(), 500);
            } else {
                showToast(result.message || 'Gagal menyimpan', 'error');
            }
        } catch (e) {
            showToast('Terjadi kesalahan: ' + e.message, 'error');
        }
    }

    // Work History Modal
    async function viewWorkHistory(id) {
        document.getElementById('historyContent').innerHTML = '<div class="text-center p-4"><i class="fas fa-spinner fa-spin"></i> Memuat...</div>';
        document.getElementById('historyModal').classList.add('active');

        try {
            const response = await fetch(`/api/employees/${id}/work-history`);
            const result = await response.json();

            if (!result.success) {
                throw new Error(result.message || 'Gagal memuat data');
            }

            const data = result.data;
            const emp = data.employee;
            const history = data.history || [];

            let historyHtml = '';
            if (history.length > 0) {
                historyHtml = `
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Tipe</th>
                                <th>No. Order</th>
                                <th>Proses</th>
                                <th>Qty</th>
                                <th>Tanggal</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${history.map(h => `
                                <tr>
                                    <td>
                                        <span class="type-badge type-${h.type}">
                                            <i class="fas ${h.type === 'supervisor' ? 'fa-user-tie' : 'fa-hard-hat'}"></i>
                                            ${h.type === 'supervisor' ? 'Supervisor' : 'Worker'}
                                        </span>
                                    </td>
                                    <td><strong>${h.order_code}</strong></td>
                                    <td><span class="process-badge">${formatProcess(h.process)}</span></td>
                                    <td>${h.type === 'supervisor' ? h.qty_completed + '/' + h.qty_target : h.qty_done}</td>
                                    <td>${formatDate(h.date)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                historyHtml = '<div class="empty-state-mini"><i class="fas fa-inbox"></i><span>Belum ada riwayat pekerjaan</span></div>';
            }

            document.getElementById('historyContent').innerHTML = `
                <div class="employee-info-header" style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 10px;">
                    <div class="emp-avatar" style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--primary), #38ef7d); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.2rem;">
                        ${emp.name ? emp.name.charAt(0).toUpperCase() : '?'}
                    </div>
                    <div>
                        <h4 style="margin: 0;">${emp.name}</h4>
                        <span style="color: var(--text-secondary); font-size: 0.85rem;">${emp.employee_code} • ${emp.position || 'N/A'}</span>
                    </div>
                </div>
                <h5 style="margin-bottom: 1rem; color: var(--primary);"><i class="fas fa-list-alt"></i> Riwayat Pekerjaan</h5>
                ${historyHtml}
            `;
        } catch (e) {
            document.getElementById('historyContent').innerHTML = `<div class="text-center text-danger p-4"><i class="fas fa-exclamation-circle"></i> ${e.message || 'Gagal memuat data'}</div>`;
        }
    }

    function formatProcess(process) {
        const map = {
            'cutting': 'Cutting',
            'sewing': 'Sewing',
            'sablon': 'Sablon',
            'finishing': 'Finishing',
            'packing': 'Packing'
        };
        return map[process] || process || '-';
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        const d = new Date(dateStr);
        return d.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
    }
</script>

<style>
    .history-table {
        width: 100%;
        font-size: 0.85rem;
        border-collapse: collapse;
    }

    .history-table th {
        background: var(--bg-secondary);
        padding: 0.75rem;
        text-align: left;
        font-weight: 600;
    }

    .history-table td {
        padding: 0.75rem;
        border-bottom: 1px solid var(--border-color);
    }

    .type-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.25rem 0.6rem;
        border-radius: 50px;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .type-badge.type-supervisor {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
    }

    .type-badge.type-worker {
        background: linear-gradient(135deg, #4facfe, #00f2fe);
        color: white;
    }

    .process-badge {
        background: #f3f4f6;
        color: #374151;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .empty-state-mini {
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
    }

    .empty-state-mini i {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        display: block;
    }
</style>
{% endblock %}