{% extends "base.html" %}

{% block title %}DSO - {{ dso.order.order_code }}{% endblock %}

{% block content %}
<style>
    /* Document Container to mimic paper */
    .dso-paper-container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        padding: 2rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border-radius: 8px;
        font-family: 'Inter', sans-serif;
    }

    /* Actions Header */
    .actions-header {
        max-width: 1000px;
        margin: 0 auto 1.5rem auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* Table Styles Override for Document Look */
    .doc-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1.5rem;
        border: 1px solid #c0c0c0;
    }

    .doc-table th,
    .doc-table td {
        border: 1px solid #c0c0c0;
        padding: 0.5rem 0.75rem;
        vertical-align: middle;
        font-size: 0.9rem;
    }

    .doc-table th {
        background-color: #f8fafc;
        font-weight: 600;
        color: #475569;
        text-transform: uppercase;
        font-size: 0.8rem;
    }

    /* Label Columns */
    .label-col {
        background-color: #f8fafc;
        width: 120px;
        font-weight: 600;
        color: #475569;
        text-transform: uppercase;
        font-size: 0.8rem;
    }

    /* Seamless Inputs */
    .doc-input {
        width: 100%;
        border: none;
        background: transparent;
        padding: 0;
        font-weight: 500;
        color: #0f172a;
        outline: none;
        font-family: inherit;
    }

    .doc-input:focus {
        background: #f0f9ff;
        box-shadow: 0 2px 0 #3b82f6;
        /* Bottom border effect */
    }

    .doc-input::placeholder {
        color: #cbd5e1;
        font-style: italic;
    }

    /* Header Section */
    .doc-header-grid {
        display: grid;
        grid-template-columns: 200px 1fr auto 250px;
        gap: 1rem;
        align-items: center;
        margin-bottom: 2rem;
        border-bottom: 2px solid #0f172a;
        padding-bottom: 1rem;
    }

    .dso-qrcode {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 0.5rem;
    }

    .dso-qrcode img {
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        background: white;
    }

    .dso-qrcode-label {
        font-size: 0.65rem;
        color: #64748b;
        text-align: center;
        margin-top: 0.25rem;
    }

    .info-box-table {
        width: 100%;
        border: 1px solid #000;
    }

    .info-box-table td {
        border: 1px solid #000;
        padding: 4px 8px;
        font-weight: bold;
    }

    .bg-green {
        background-color: #22c55e;
        color: white;
    }

    .bg-red {
        background-color: #ef4444;
        color: white;
    }

    /* Visual Design Section */
    .visual-section-header {
        background: #3b82f6;
        color: white;
        text-align: center;
        font-weight: bold;
        padding: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        border: 1px solid #2563eb;
    }

    .visual-area {
        border: 1px solid #c0c0c0;
        border-top: none;
        min-height: 400px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fff;
        position: relative;
        margin-bottom: 1.5rem;
    }

    /* Number Cells */
    .num-cell {
        width: 40px;
        text-align: center;
        background: #f8fafc;
        font-weight: 600;
        color: #64748b;
    }

    .size-input-cell input {
        text-align: center;
    }

    /* Upload Button Overlay */
    .upload-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.2s;
        cursor: pointer;
    }

    .visual-area:hover .upload-overlay,
    .visual-area.empty .upload-overlay {
        opacity: 1;
    }
</style>

<!-- Action Header (Outside Paper) -->
<div class="actions-header">
    <div>
        <a href="/orders/{{ dso.order.order_code }}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-arrow-left me-1"></i> Kembali
        </a>
    </div>
    <div class="d-flex gap-2">
        <a href="/api/dso/{{ dso.id }}/export-word" class="btn btn-white border text-primary fw-semibold btn-sm">
            <i class="fas fa-file-word me-1"></i> Word
        </a>
        <a href="/api/dso/{{ dso.id }}/export-pdf" class="btn btn-white border text-danger fw-semibold btn-sm">
            <i class="fas fa-file-pdf me-1"></i> PDF
        </a>
        <button onclick="saveDSO()" class="btn btn-primary btn-sm px-4 fw-bold">
            <i class="fas fa-save me-1"></i> SIMPAN
        </button>
    </div>
</div>

<!-- The Document Paper -->
<div class="dso-paper-container">

    <!-- Header -->
    <div class="doc-header-grid">
        <div class="logo-area">
            <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Greens Production"
                style="max-height: 60px;">
        </div>
        <div class="text-center">
            <h4 class="mb-0 fw-bold text-uppercase">Design Specification Order (DSO)</h4>
        </div>
        <div class="dso-qrcode">
            <img id="dsoQrcodeImage" src="" alt="QR Code" style="width: 70px; height: 70px; display: none;">
            <div class="dso-qrcode-label" id="dsoQrcodeLabel" style="display: none;">{{ dso.order.order_code }}</div>
        </div>
        <div>
            <table class="info-box-table text-center" style="font-size: 0.8rem;">
                <tr>
                    <td class="bg-red" style="width: 80px;">NO INV</td>
                    <td class="text-danger">{{ dso.order.order_code }}</td>
                </tr>
                <tr>
                    <td class="bg-green">DUE DATE</td>
                    <td>{{ dso.order.deadline.strftime('%d/%m/%Y') if dso.order.deadline else '-' }}</td>
                </tr>
            </table>
        </div>
    </div>

    <!-- Specs Table Row -->
    <div class="row g-0">
        <!-- Left: Basic Specs & Left Acc -->
        <div class="col-6 pe-3">
            <table class="doc-table">
                <tbody>
                    <tr>
                        <td class="label-col">MODEL</td>
                        <td><input type="text" name="model" class="doc-input" value="{{ dso.order.model or '' }}"></td>
                    </tr>
                    <tr>
                        <td class="label-col">BAHAN</td>
                        <td><input type="text" name="bahan" class="doc-input" value="{{ dso.bahan or '' }}"></td>
                    </tr>
                    <tr>
                        <td class="label-col">WARNA</td>
                        <td><input type="text" name="warna" class="doc-input" value="{{ dso.warna or '' }}"></td>
                    </tr>
                    <!-- ACC Section embedded in left table as per layout often seen -->
                    <!-- But layout shows ACC list separate. Let's follow the image structure -->
                    <!-- Image: Table Left (Model, Bahan, Warna, ACC blocks), Table Right (Jenis, Sablon, Posisi, Kancing...) -->

                    <tr>
                        <td class="label-col align-top pt-2" rowspan="5">ACC</td>
                        <td class="p-0 border-0">
                            <table class="w-100 m-0 border-0">
                                {% for i in range(1, 6) %}
                                <tr>
                                    <td class="num-cell py-1 border-0 border-bottom border-end" style="width: 30px;">{{
                                        i }}</td>
                                    <td class="py-1 border-0 border-bottom"><input type="text" name="acc_{{ i }}"
                                            class="doc-input" value="{{ dso['acc_' ~ i] or '' }}"></td>
                                </tr>
                                {% endfor %}
                            </table>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Right: Detail Specs -->
        <div class="col-6 ps-3">
            <table class="doc-table">
                <tbody>
                    <tr>
                        <td class="label-col" style="width: 140px;">JENIS</td>
                        <td><input type="text" name="jenis" class="doc-input" value="{{ dso.jenis or '' }}"></td>
                    </tr>
                    <tr>
                        <td class="label-col">SABLON</td>
                        <td><input type="text" name="sablon" class="doc-input" value="{{ dso.sablon or '' }}"></td>
                    </tr>
                    <tr>
                        <td class="label-col">POSISI</td>
                        <td><input type="text" name="posisi" class="doc-input" value="{{ dso.posisi or '' }}"
                                placeholder="-"></td>
                    </tr>
                    <tr>
                        <td class="label-col">KANCING</td>
                        <td><input type="text" name="kancing" class="doc-input" value="{{ dso.kancing or '' }}"></td>
                    </tr>
                    <tr>
                        <td class="label-col">SAKU</td>
                        <td><input type="text" name="saku" class="doc-input" value="{{ dso.saku or '' }}"></td>
                    </tr>
                    <tr>
                        <td class="label-col">RESLETING</td>
                        <td><input type="text" name="resleting" class="doc-input" value="{{ dso.resleting or '' }}">
                        </td>
                    </tr>
                    <tr>
                        <td class="label-col">MODEL BADAN BAWAH</td>
                        <td style="font-size: 0.8rem;"><input type="text" name="model_badan_bawah" class="doc-input"
                                value="{{ dso.model_badan_bawah or '' }}"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Tampak Depan -->
    <div class="mb-4">
        <div class="visual-section-header">TAMPAK DEPAN</div>
        <div class="visual-area {% if not dso.gambar_depan_url %}empty{% endif %}">
            <input type="file" id="uploadGambar" accept="image/*" class="d-none" onchange="uploadGambarDepan(this)">

            {% if dso.gambar_depan_url %}
            <img src="{{ dso.gambar_depan_url }}" id="gambarDepan"
                style="max-width: 100%; max-height: 400px; object-fit: contain;">
            <div class="upload-overlay" onclick="document.getElementById('uploadGambar').click()">
                <div class="bg-white p-2 rounded shadow text-dark fw-bold border">
                    <i class="fas fa-camera me-1"></i> Ganti Desain
                </div>
            </div>
            {% else %}
            <div class="upload-overlay" onclick="document.getElementById('uploadGambar').click()">
                <div class="text-center text-secondary">
                    <i class="fas fa-cloud-upload-alt fa-3x mb-2 text-primary"></i>
                    <div class="fw-bold text-dark">UPLOAD GAMBAR DESAIN</div>
                    <div class="small">Klik area ini untuk memilih file</div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Notes & Label Row -->
    <div class="row mb-4">
        <div class="col-8">
            <table class="doc-table mb-0">
                <tr>
                    <td class="label-col text-center" rowspan="6" style="width: 120px;">CATATAN<br>CUSTOMER</td>
                    <td class="num-cell" style="width: 40px !important;">1</td>
                    <td><input type="text" name="catatan_customer_1" class="doc-input"
                            value="{{ dso.catatan_customer_1 or '' }}"></td>
                </tr>
                {% for i in range(2, 7) %}
                <tr>
                    <td class="num-cell">{{ i }}</td>
                    <td><input type="text" name="catatan_customer_{{ i }}" class="doc-input"
                            value="{{ dso['catatan_customer_' ~ i] or '' }}"></td>
                </tr>
                {% endfor %}
            </table>
        </div>
        <div class="col-4">
            <table class="doc-table mb-0" style="height: 100%;">
                <tr>
                    <td class="label-col text-center border-bottom-0" style="height: 40px;">LABEL</td>
                </tr>
                <tr>
                    <td class="p-2 border-top-0 align-top" style="height: 100%;">
                        <textarea name="label" class="doc-input w-100 h-100 text-center"
                            style="min-height: 150px; resize: none;" placeholder="-">{{ dso.label or '' }}</textarea>
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <!-- Size Charts -->
    <div class="mb-2">
        <div class="doc-table mt-0 mb-0 border-bottom-0 bg-light fw-bold px-2 py-1 border border-bottom-0"
            style="font-size: 0.85rem;">S. CHART DEWASA</div>
        <div class="table-responsive">
            <table class="doc-table text-center mb-4">
                <thead>
                    <tr>
                        <th style="width: 100px;">Ukuran</th>
                        {% for size in ['XS','S','M','L','XL','XXL','3XL','4XL','5XL'] %}
                        <th>{{ size }}</th>
                        {% endfor %}
                        <th class="bg-light text-primary">JUM</th>
                        <th class="bg-light text-success">TOTAL</th>
                    </tr>
                </thead>
                <tbody>
                    {% set dewasa = dso.size_chart_dewasa %}
                    <tr>
                        <td class="fw-bold text-start ps-3">Pendek</td>
                        {% for size in ['xs','s','m','l','xl','xxl','x3l','x4l','x5l'] %}
                        <td class="size-input-cell"><input type="number" name="dewasa_pendek_{{ size }}"
                                class="doc-input" value="{{ dewasa['pendek_' ~ size] if dewasa else 0 }}" min="0"
                                onchange="calcDewasa()"></td>
                        {% endfor %}
                        <td class="fw-bold text-primary" id="jumDewasaPendek">{{ dewasa.jum_pendek if dewasa else 0 }}
                        </td>
                        <td class="fw-bold text-success fs-5 align-middle" rowspan="2" id="totalDewasa">{{ dewasa.total
                            if dewasa else 0 }}</td>
                    </tr>
                    <tr>
                        <td class="fw-bold text-start ps-3">Panjang</td>
                        {% for size in ['xs','s','m','l','xl','xxl','x3l','x4l','x5l'] %}
                        <td class="size-input-cell"><input type="number" name="dewasa_panjang_{{ size }}"
                                class="doc-input" value="{{ dewasa['panjang_' ~ size] if dewasa else 0 }}" min="0"
                                onchange="calcDewasa()"></td>
                        {% endfor %}
                        <td class="fw-bold text-primary" id="jumDewasaPanjang">{{ dewasa.jum_panjang if dewasa else 0 }}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="doc-table mt-0 mb-0 border-bottom-0 bg-light fw-bold px-2 py-1 border border-bottom-0"
            style="font-size: 0.85rem;">S. CHART ANAK</div>
        <div class="table-responsive">
            <table class="doc-table text-center mb-0">
                <thead>
                    <tr>
                        <th style="width: 100px;">Ukuran</th>
                        {% for size in ['XS','S','M','L','XL','XXL','3XL','4XL','5XL'] %}
                        <th>{{ size }}</th>
                        {% endfor %}
                        <th class="bg-light text-primary">JUM</th>
                        <th class="bg-light text-success">TOTAL</th>
                    </tr>
                </thead>
                <tbody>
                    {% set anak = dso.size_chart_anak %}
                    <tr>
                        <td class="fw-bold text-start ps-3">Pendek</td>
                        {% for size in ['xs','s','m','l','xl','xxl','x3l','x4l','x5l'] %}
                        <td class="size-input-cell"><input type="number" name="anak_pendek_{{ size }}" class="doc-input"
                                value="{{ anak['pendek_' ~ size] if anak else 0 }}" min="0" onchange="calcAnak()"></td>
                        {% endfor %}
                        <td class="fw-bold text-primary" id="jumAnakPendek">{{ anak.jum_pendek if anak else 0 }}</td>
                        <td class="fw-bold text-success fs-5 align-middle" rowspan="2" id="totalAnak">{{ anak.total if
                            anak else 0 }}</td>
                    </tr>
                    <tr>
                        <td class="fw-bold text-start ps-3">Panjang</td>
                        {% for size in ['xs','s','m','l','xl','xxl','x3l','x4l','x5l'] %}
                        <td class="size-input-cell"><input type="number" name="anak_panjang_{{ size }}"
                                class="doc-input" value="{{ anak['panjang_' ~ size] if anak else 0 }}" min="0"
                                onchange="calcAnak()"></td>
                        {% endfor %}
                        <td class="fw-bold text-primary" id="jumAnakPanjang">{{ anak.jum_panjang if anak else 0 }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- Scripts reused -->
<script>
    // Include same calc functions and logic
    function calcDewasa() {
        const sizes = ['xs', 's', 'm', 'l', 'xl', 'xxl', 'x3l', 'x4l', 'x5l'];
        let jumPendek = 0, jumPanjang = 0;

        sizes.forEach(size => {
            jumPendek += parseInt(document.querySelector(`[name="dewasa_pendek_${size}"]`)?.value) || 0;
            jumPanjang += parseInt(document.querySelector(`[name="dewasa_panjang_${size}"]`)?.value) || 0;
        });

        document.getElementById('jumDewasaPendek').textContent = jumPendek;
        document.getElementById('jumDewasaPanjang').textContent = jumPanjang;
        document.getElementById('totalDewasa').textContent = jumPendek + jumPanjang;
    }

    function calcAnak() {
        const sizes = ['xs', 's', 'm', 'l', 'xl', 'xxl', 'x3l', 'x4l', 'x5l'];
        let jumPendek = 0, jumPanjang = 0;

        sizes.forEach(size => {
            jumPendek += parseInt(document.querySelector(`[name="anak_pendek_${size}"]`)?.value) || 0;
            jumPanjang += parseInt(document.querySelector(`[name="anak_panjang_${size}"]`)?.value) || 0;
        });

        document.getElementById('jumAnakPendek').textContent = jumPendek;
        document.getElementById('jumAnakPanjang').textContent = jumPanjang;
        document.getElementById('totalAnak').textContent = jumPendek + jumPanjang;
    }

    function uploadGambarDepan(input) {
        if (input.files && input.files[0]) {
            // Preview only first
            const reader = new FileReader();
            reader.onload = function (e) {
                const img = document.getElementById('gambarDepan');
                if (img) {
                    img.src = e.target.result;
                } else {
                    // If fresh upload
                    const container = document.querySelector('.visual-area');
                    container.classList.remove('empty');
                    container.innerHTML = `
                        <input type="file" id="uploadGambar" accept="image/*" class="d-none" onchange="uploadGambarDepan(this)">
                        <img src="${e.target.result}" id="gambarDepan" style="max-width: 100%; max-height: 400px; object-fit: contain;">
                        <div class="upload-overlay" onclick="document.getElementById('uploadGambar').click()">
                             <div class="bg-white p-2 rounded shadow text-dark fw-bold border">
                                 <i class="fas fa-camera me-1"></i> Ganti Desain
                             </div>
                        </div>
                     `;
                }
            }
            reader.readAsDataURL(input.files[0]);

            const formData = new FormData();
            formData.append('gambar_depan', input.files[0]);
            showLoading();

            const headers = {};
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            if (csrfToken) headers['X-CSRFToken'] = csrfToken;

            fetch('/api/dso/{{ dso.id }}/upload', {
                method: 'PUT',
                body: formData,
                headers: headers, // Do NOT set Content-Type here, let browser set multipart/form-data
                credentials: 'same-origin'
            })
                .then(async response => {
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Upload failed');
                    return data;
                })
                .then(() => {
                    hideLoading();
                    showToast('Desain berhasil diupdate', 'success');
                }).catch(err => {
                    hideLoading();
                    showToast(err.message || 'Upload gagal', 'error');
                });
        }
    }

    async function saveDSO() {
        showLoading();
        // Collect data
        const dsoData = {
            model: document.querySelector('[name="model"]').value,
            jenis: document.querySelector('[name="jenis"]').value,
            bahan: document.querySelector('[name="bahan"]').value,
            warna: document.querySelector('[name="warna"]').value,
            sablon: document.querySelector('[name="sablon"]').value,
            posisi: document.querySelector('[name="posisi"]').value,
            kancing: document.querySelector('[name="kancing"]').value,
            saku: document.querySelector('[name="saku"]').value,
            resleting: document.querySelector('[name="resleting"]').value,
            model_badan_bawah: document.querySelector('[name="model_badan_bawah"]').value,
            label: document.querySelector('[name="label"]').value,
        };

        for (let i = 1; i <= 5; i++) dsoData[`acc_${i}`] = document.querySelector(`[name="acc_${i}"]`).value;
        for (let i = 1; i <= 6; i++) dsoData[`catatan_customer_${i}`] = document.querySelector(`[name="catatan_customer_${i}"]`).value;

        dsoData.size_chart_dewasa = {};
        dsoData.size_chart_anak = {};
        const sizes = ['xs', 's', 'm', 'l', 'xl', 'xxl', 'x3l', 'x4l', 'x5l'];
        sizes.forEach(s => {
            dsoData.size_chart_dewasa[`pendek_${s}`] = parseInt(document.querySelector(`[name="dewasa_pendek_${s}"]`)?.value) || 0;
            dsoData.size_chart_dewasa[`panjang_${s}`] = parseInt(document.querySelector(`[name="dewasa_panjang_${s}"]`)?.value) || 0;
            dsoData.size_chart_anak[`pendek_${s}`] = parseInt(document.querySelector(`[name="anak_pendek_${s}"]`)?.value) || 0;
            dsoData.size_chart_anak[`panjang_${s}`] = parseInt(document.querySelector(`[name="anak_panjang_${s}"]`)?.value) || 0;
        });

        // Explicitly set status to published to approve the DSO
        dsoData.status = 'published';

        try {
            await api.put('/dso/{{ dso.id }}', dsoData);
            hideLoading();
            showToast('DSO berhasil disimpan dan diterbitkan!', 'success');
            // Reload to reflect status change visually if needed
            setTimeout(() => window.location.reload(), 1500);
        } catch (error) {
            hideLoading();
            showToast(error.message || 'Gagal menyimpan DSO', 'error');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        calcDewasa();
        calcAnak();
        loadDsoQRCode();
    });

    async function loadDsoQRCode() {
        try {
            const orderId = {{ dso.order_id }};
            const response = await api.get('/barcodes/qc-qrcode/' + orderId);
            if (response.success && response.data.qr_image) {
                const qrImg = document.getElementById('dsoQrcodeImage');
                const qrLabel = document.getElementById('dsoQrcodeLabel');
                qrImg.src = response.data.qr_image;
                qrImg.style.display = 'block';
                qrLabel.style.display = 'block';
            }
        } catch (error) {
            console.log('DSO QR code loading failed:', error);
        }
    }
</script>
{% endblock %}