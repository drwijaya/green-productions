{% extends "base.html" %}

{% block title %}DSO - {{ dso.order.order_code }}{% endblock %}
{% block page_title %}Design Specification Order{% endblock %}

{% block content %}
<div class="page-header mb-4">
    <div class="page-header-left">
        <a href="{{ url_for('views.order_detail', order_id=dso.order_id) }}" class="btn btn-sm btn-outline">
            <i class="fas fa-arrow-left"></i> Kembali
        </a>
    </div>
    <div class="page-header-right">
        <button class="btn btn-outline" onclick="window.print()">
            <i class="fas fa-print"></i> Print
        </button>
        <button class="btn btn-primary" onclick="saveDSO()">
            <i class="fas fa-save"></i> Simpan
        </button>
    </div>
</div>

<!-- DSO Document Container -->
<div class="dso-document" id="dsoDocument">
    <!-- Header Section -->
    <div class="dso-header">
        <div class="dso-logo">
            <div class="logo-box">
                <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Green Production"
                    style="max-height: 60px; max-width: 100%;">
            </div>
        </div>
        <div class="dso-title">
            <h1>Design Specification Order (DSO)</h1>
        </div>
        <div class="dso-info">
            <table class="info-table">
                <tr>
                    <td class="label-inv">NO INV</td>
                    <td class="value-inv">{{ dso.order.order_code }}</td>
                </tr>
                <tr>
                    <td class="label-due">DUE DATE</td>
                    <td class="value-due">
                        <input type="date" name="due_date"
                            value="{{ dso.order.deadline.strftime('%Y-%m-%d') if dso.order.deadline else '' }}">
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <!-- Combined Product Info + ACC Section -->
    <div class="dso-main-table">
        <table class="spec-table">
            <tbody>
                <!-- Row 1: MODEL + JENIS | ACC 1 + KANCING -->
                <tr>
                    <td class="label">MODEL</td>
                    <td><input type="text" name="model" value="{{ dso.order.model or '' }}"></td>
                    <td class="label">JENIS</td>
                    <td><input type="text" name="jenis" value="{{ dso.jenis or '' }}"></td>
                    <td class="spacer"></td>
                    <td class="label acc-label" rowspan="5">ACC</td>
                    <td class="num">1</td>
                    <td><input type="text" name="acc_1" value="{{ dso.acc_1 or '' }}"></td>
                    <td class="label">KANCING</td>
                    <td><input type="text" name="kancing" value="{{ dso.kancing or '' }}"></td>
                </tr>
                <!-- Row 2: BAHAN + SABLON | ACC 2 + SAKU -->
                <tr>
                    <td class="label">BAHAN</td>
                    <td><input type="text" name="bahan" value="{{ dso.bahan or '' }}"></td>
                    <td class="label">SABLON</td>
                    <td><input type="text" name="sablon" value="{{ dso.sablon or '' }}"></td>
                    <td class="spacer"></td>
                    <td class="num">2</td>
                    <td><input type="text" name="acc_2" value="{{ dso.acc_2 or '' }}"></td>
                    <td class="label">SAKU</td>
                    <td><input type="text" name="saku" value="{{ dso.saku or '' }}"></td>
                </tr>
                <!-- Row 3: WARNA + POSISI | ACC 3 + RESLETING -->
                <tr>
                    <td class="label">WARNA</td>
                    <td><input type="text" name="warna" value="{{ dso.warna or '' }}"></td>
                    <td class="label">POSISI</td>
                    <td><input type="text" name="posisi" value="{{ dso.posisi or '' }}"></td>
                    <td class="spacer"></td>
                    <td class="num">3</td>
                    <td><input type="text" name="acc_3" value="{{ dso.acc_3 or '' }}"></td>
                    <td class="label">RESLETING</td>
                    <td><input type="text" name="resleting" value="{{ dso.resleting or '' }}"></td>
                </tr>
                <!-- Row 4: Empty | ACC 4 + MODEL BADAN BAWAH -->
                <tr>
                    <td class="label"></td>
                    <td></td>
                    <td class="label"></td>
                    <td></td>
                    <td class="spacer"></td>
                    <td class="num">4</td>
                    <td><input type="text" name="acc_4" value="{{ dso.acc_4 or '' }}"></td>
                    <td class="label">MODEL BADAN<br>BAWAH</td>
                    <td><input type="text" name="model_badan_bawah" value="{{ dso.model_badan_bawah or '' }}"></td>
                </tr>
                <!-- Row 5: Empty | ACC 5 + Empty -->
                <tr>
                    <td class="label"></td>
                    <td></td>
                    <td class="label"></td>
                    <td></td>
                    <td class="spacer"></td>
                    <td class="num">5</td>
                    <td><input type="text" name="acc_5" value="{{ dso.acc_5 or '' }}"></td>
                    <td class="label"></td>
                    <td></td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- TAMPAK DEPAN Section -->
    <div class="tampak-depan-section">
        <div class="tampak-header">TAMPAK DEPAN</div>
        <div class="tampak-content" id="imageArea">
            {% if dso.gambar_depan_url %}
            <img src="{{ dso.gambar_depan_url }}" alt="Tampak Depan" id="gambarDepan">
            <button class="btn btn-sm btn-outline change-btn" onclick="document.getElementById('uploadGambar').click()">
                <i class="fas fa-sync"></i> Ganti
            </button>
            {% else %}
            <div class="upload-placeholder" onclick="document.getElementById('uploadGambar').click()">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Klik untuk upload gambar desain</span>
            </div>
            {% endif %}
            <input type="file" id="uploadGambar" accept="image/*" style="display:none"
                onchange="uploadGambarDepan(this)">
        </div>
    </div>

    <!-- Catatan Customer & Label Section -->
    <div class="catatan-section">
        <table class="catatan-table">
            <tbody>
                <tr>
                    <td class="label catatan-label" rowspan="6">CATATAN<br>CUSTOMER</td>
                    <td class="num">1</td>
                    <td class="catatan-input"><input type="text" name="catatan_customer_1"
                            value="{{ dso.catatan_customer_1 or '' }}"></td>
                    <td class="label label-right" rowspan="6">LABEL</td>
                    <td class="label-input" rowspan="6"><textarea name="label" rows="6">{{ dso.label or '' }}</textarea>
                    </td>
                </tr>
                <tr>
                    <td class="num">2</td>
                    <td class="catatan-input"><input type="text" name="catatan_customer_2"
                            value="{{ dso.catatan_customer_2 or '' }}"></td>
                </tr>
                <tr>
                    <td class="num">3</td>
                    <td class="catatan-input"><input type="text" name="catatan_customer_3"
                            value="{{ dso.catatan_customer_3 or '' }}"></td>
                </tr>
                <tr>
                    <td class="num">4</td>
                    <td class="catatan-input"><input type="text" name="catatan_customer_4"
                            value="{{ dso.catatan_customer_4 or '' }}"></td>
                </tr>
                <tr>
                    <td class="num">5</td>
                    <td class="catatan-input"><input type="text" name="catatan_customer_5"
                            value="{{ dso.catatan_customer_5 or '' }}"></td>
                </tr>
                <tr>
                    <td class="num">6</td>
                    <td class="catatan-input"><input type="text" name="catatan_customer_6"
                            value="{{ dso.catatan_customer_6 or '' }}"></td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- S. Chart Dewasa -->
    <div class="size-chart-section">
        <div class="chart-title">S. Chart Dewasa</div>
        <table class="size-table" id="chartDewasa">
            <thead>
                <tr>
                    <th class="col-ukuran">Ukuran</th>
                    <th>XS</th>
                    <th>S</th>
                    <th>M</th>
                    <th>L</th>
                    <th>XL</th>
                    <th>XXL</th>
                    <th>X3L</th>
                    <th>X4L</th>
                    <th>X5L</th>
                    <th class="col-jum">JUM</th>
                    <th class="col-total">TOTAL</th>
                </tr>
            </thead>
            <tbody>
                {% set dewasa = dso.size_chart_dewasa %}
                <tr>
                    <td class="row-label">Pendek</td>
                    <td><input type="number" name="dewasa_pendek_xs" value="{{ dewasa.pendek_xs if dewasa else 0 }}"
                            min="0" onchange="calcDewasa()"></td>
                    <td><input type="number" name="dewasa_pendek_s" value="{{ dewasa.pendek_s if dewasa else 0 }}"
                            min="0" onchange="calcDewasa()"></td>
                    <td><input type="number" name="dewasa_pendek_m" value="{{ dewasa.pendek_m if dewasa else 0 }}"
                            min="0" onchange="calcDewasa()"></td>
                    <td><input type="number" name="dewasa_pendek_l" value="{{ dewasa.pendek_l if dewasa else 0 }}"
                            min="0" onchange="calcDewasa()"></td>
                    <td><input type="number" name="dewasa_pendek_xl" value="{{ dewasa.pendek_xl if dewasa else 0 }}"
                            min="0" onchange="calcDewasa()"></td>
                    <td><input type="number" name="dewasa_pendek_xxl" value="{{ dewasa.pendek_xxl if dewasa else 0 }}"
                            min="0" onchange="calcDewasa()"></td>
                    <td><input type="number" name="dewasa_pendek_x3l" value="{{ dewasa.pendek_x3l if dewasa else 0 }}"
                            min="0" onchange="calcDewasa()"></td>
                    <td><input type="number" name="dewasa_pendek_x4l" value="{{ dewasa.pendek_x4l if dewasa else 0 }}"
                            min="0" onchange="calcDewasa()"></td>
                    <td><input type="number" name="dewasa_pendek_x5l" value="{{ dewasa.pendek_x5l if dewasa else 0 }}"
                            min="0" onchange="calcDewasa()"></td>
                    <td class="jum" id="jumDewasaPendek">{{ dewasa.jum_pendek if dewasa else 0 }}</td>
                    <td class="total" rowspan="2" id="totalDewasa">{{ dewasa.total if dewasa else 0 }}</td>
                </tr>
                <tr>
                    <td class="row-label">Panjang</td>
                    <td><input type="number" name="dewasa_panjang_xs" value="{{ dewasa.panjang_xs if dewasa else 0 }}"
                            min="0" onchange="calcDewasa()"></td>
                    <td><input type="number" name="dewasa_panjang_s" value="{{ dewasa.panjang_s if dewasa else 0 }}"
                            min="0" onchange="calcDewasa()"></td>
                    <td><input type="number" name="dewasa_panjang_m" value="{{ dewasa.panjang_m if dewasa else 0 }}"
                            min="0" onchange="calcDewasa()"></td>
                    <td><input type="number" name="dewasa_panjang_l" value="{{ dewasa.panjang_l if dewasa else 0 }}"
                            min="0" onchange="calcDewasa()"></td>
                    <td><input type="number" name="dewasa_panjang_xl" value="{{ dewasa.panjang_xl if dewasa else 0 }}"
                            min="0" onchange="calcDewasa()"></td>
                    <td><input type="number" name="dewasa_panjang_xxl" value="{{ dewasa.panjang_xxl if dewasa else 0 }}"
                            min="0" onchange="calcDewasa()"></td>
                    <td><input type="number" name="dewasa_panjang_x3l" value="{{ dewasa.panjang_x3l if dewasa else 0 }}"
                            min="0" onchange="calcDewasa()"></td>
                    <td><input type="number" name="dewasa_panjang_x4l" value="{{ dewasa.panjang_x4l if dewasa else 0 }}"
                            min="0" onchange="calcDewasa()"></td>
                    <td><input type="number" name="dewasa_panjang_x5l" value="{{ dewasa.panjang_x5l if dewasa else 0 }}"
                            min="0" onchange="calcDewasa()"></td>
                    <td class="jum" id="jumDewasaPanjang">{{ dewasa.jum_panjang if dewasa else 0 }}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- S. Chart Anak -->
    <div class="size-chart-section">
        <div class="chart-title">S. Chart Anak</div>
        <table class="size-table" id="chartAnak">
            <thead>
                <tr>
                    <th class="col-ukuran">Ukuran</th>
                    <th>XS</th>
                    <th>S</th>
                    <th>M</th>
                    <th>L</th>
                    <th>XL</th>
                    <th>XXL</th>
                    <th>X3L</th>
                    <th>X4L</th>
                    <th>X5L</th>
                    <th class="col-jum">JUM</th>
                    <th class="col-total">TOTAL</th>
                </tr>
            </thead>
            <tbody>
                {% set anak = dso.size_chart_anak %}
                <tr>
                    <td class="row-label">Pendek</td>
                    <td><input type="number" name="anak_pendek_xs" value="{{ anak.pendek_xs if anak else 0 }}" min="0"
                            onchange="calcAnak()"></td>
                    <td><input type="number" name="anak_pendek_s" value="{{ anak.pendek_s if anak else 0 }}" min="0"
                            onchange="calcAnak()"></td>
                    <td><input type="number" name="anak_pendek_m" value="{{ anak.pendek_m if anak else 0 }}" min="0"
                            onchange="calcAnak()"></td>
                    <td><input type="number" name="anak_pendek_l" value="{{ anak.pendek_l if anak else 0 }}" min="0"
                            onchange="calcAnak()"></td>
                    <td><input type="number" name="anak_pendek_xl" value="{{ anak.pendek_xl if anak else 0 }}" min="0"
                            onchange="calcAnak()"></td>
                    <td><input type="number" name="anak_pendek_xxl" value="{{ anak.pendek_xxl if anak else 0 }}" min="0"
                            onchange="calcAnak()"></td>
                    <td><input type="number" name="anak_pendek_x3l" value="{{ anak.pendek_x3l if anak else 0 }}" min="0"
                            onchange="calcAnak()"></td>
                    <td><input type="number" name="anak_pendek_x4l" value="{{ anak.pendek_x4l if anak else 0 }}" min="0"
                            onchange="calcAnak()"></td>
                    <td><input type="number" name="anak_pendek_x5l" value="{{ anak.pendek_x5l if anak else 0 }}" min="0"
                            onchange="calcAnak()"></td>
                    <td class="jum" id="jumAnakPendek">{{ anak.jum_pendek if anak else 0 }}</td>
                    <td class="total" rowspan="2" id="totalAnak">{{ anak.total if anak else 0 }}</td>
                </tr>
                <tr>
                    <td class="row-label">Panjang</td>
                    <td><input type="number" name="anak_panjang_xs" value="{{ anak.panjang_xs if anak else 0 }}" min="0"
                            onchange="calcAnak()"></td>
                    <td><input type="number" name="anak_panjang_s" value="{{ anak.panjang_s if anak else 0 }}" min="0"
                            onchange="calcAnak()"></td>
                    <td><input type="number" name="anak_panjang_m" value="{{ anak.panjang_m if anak else 0 }}" min="0"
                            onchange="calcAnak()"></td>
                    <td><input type="number" name="anak_panjang_l" value="{{ anak.panjang_l if anak else 0 }}" min="0"
                            onchange="calcAnak()"></td>
                    <td><input type="number" name="anak_panjang_xl" value="{{ anak.panjang_xl if anak else 0 }}" min="0"
                            onchange="calcAnak()"></td>
                    <td><input type="number" name="anak_panjang_xxl" value="{{ anak.panjang_xxl if anak else 0 }}"
                            min="0" onchange="calcAnak()"></td>
                    <td><input type="number" name="anak_panjang_x3l" value="{{ anak.panjang_x3l if anak else 0 }}"
                            min="0" onchange="calcAnak()"></td>
                    <td><input type="number" name="anak_panjang_x4l" value="{{ anak.panjang_x4l if anak else 0 }}"
                            min="0" onchange="calcAnak()"></td>
                    <td><input type="number" name="anak_panjang_x5l" value="{{ anak.panjang_x5l if anak else 0 }}"
                            min="0" onchange="calcAnak()"></td>
                    <td class="jum" id="jumAnakPanjang">{{ anak.jum_panjang if anak else 0 }}</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<style>
    /* DSO Document - Clean Professional Style */
    .dso-document {
        background: white;
        max-width: 1000px;
        margin: 0 auto;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border-radius: 8px;
        font-family: 'Segoe UI', Arial, sans-serif;
    }

    /* Header */
    .dso-header {
        display: grid;
        grid-template-columns: 200px 1fr 200px;
        align-items: center;
        gap: 1rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid #e5e7eb;
        margin-bottom: 1.5rem;
    }

    .logo-box {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .logo-icon {
        font-size: 2rem;
    }

    .logo-text {
        display: flex;
        flex-direction: column;
        line-height: 1.2;
    }

    .logo-text strong {
        font-size: 1.1rem;
        color: #16a34a;
        letter-spacing: 1px;
    }

    .logo-text span {
        font-size: 0.7rem;
        color: #6b7280;
        letter-spacing: 2px;
    }

    .logo-text small {
        font-size: 0.6rem;
        color: #9ca3af;
    }

    .dso-title h1 {
        font-size: 1rem;
        font-weight: 600;
        text-align: center;
        color: #374151;
        margin: 0;
    }

    .info-table {
        border-collapse: collapse;
        width: 100%;
    }

    .info-table td {
        padding: 0.35rem 0.5rem;
        font-size: 0.8rem;
    }

    .info-table .label-inv {
        background: #ef4444;
        color: white;
        font-weight: 600;
        text-align: center;
        border-radius: 3px 0 0 3px;
    }

    .info-table .value-inv {
        background: #fef2f2;
        border: 1px solid #fecaca;
        font-weight: 600;
        color: #dc2626;
    }

    .info-table .label-due {
        background: #22c55e;
        color: white;
        font-weight: 600;
        text-align: center;
        border-radius: 3px 0 0 3px;
    }

    .info-table .value-due {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
    }

    .info-table input {
        border: none;
        background: transparent;
        width: 100%;
        font-size: 0.8rem;
        padding: 0;
    }

    /* Main Spec Table */
    .dso-main-table {
        margin-bottom: 1.5rem;
    }

    .spec-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
    }

    .spec-table td {
        border: 1px solid #d1d5db;
        padding: 0.5rem 0.75rem;
        height: 38px;
    }

    .spec-table td.label {
        background: #f9fafb;
        font-weight: 600;
        color: #374151;
        width: 100px;
        text-align: center;
    }

    .spec-table td.acc-label {
        width: 60px;
        vertical-align: middle;
    }

    .spec-table td.num {
        width: 30px;
        text-align: center;
        background: #f9fafb;
        color: #6b7280;
    }

    .spec-table td.spacer {
        width: 20px;
        border: none;
        background: transparent;
    }

    .spec-table input {
        width: 100%;
        border: none;
        background: transparent;
        padding: 0.25rem;
        font-size: 0.85rem;
    }

    .spec-table input:focus {
        outline: none;
        background: #fef9c3;
    }

    /* Tampak Depan */
    .tampak-depan-section {
        margin-bottom: 1.5rem;
        border: 1px solid #d1d5db;
    }

    .tampak-header {
        background: #3b82f6;
        color: white;
        padding: 0.6rem 1rem;
        font-weight: 600;
        font-size: 0.9rem;
        text-align: center;
    }

    .tampak-content {
        min-height: 350px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fafafa;
        position: relative;
    }

    .tampak-content img {
        max-width: 100%;
        max-height: 350px;
        object-fit: contain;
    }

    .tampak-content .change-btn {
        position: absolute;
        bottom: 10px;
        right: 10px;
    }

    .upload-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
        color: #9ca3af;
        cursor: pointer;
        padding: 3rem;
        transition: all 0.2s;
    }

    .upload-placeholder:hover {
        color: #3b82f6;
    }

    .upload-placeholder i {
        font-size: 3rem;
    }

    /* Catatan Section */
    .catatan-section {
        margin-bottom: 1.5rem;
    }

    .catatan-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
    }

    .catatan-table td {
        border: 1px solid #d1d5db;
        padding: 0.4rem 0.5rem;
    }

    .catatan-table .catatan-label {
        width: 100px;
        background: #f9fafb;
        font-weight: 600;
        text-align: center;
        vertical-align: middle;
    }

    .catatan-table .num {
        width: 30px;
        text-align: center;
        background: #f9fafb;
        color: #6b7280;
    }

    .catatan-table .catatan-input {
        width: 45%;
    }

    .catatan-table .label-right {
        width: 80px;
        background: #f9fafb;
        font-weight: 600;
        text-align: center;
        vertical-align: middle;
    }

    .catatan-table .label-input {
        width: 25%;
        vertical-align: top;
    }

    .catatan-table input,
    .catatan-table textarea {
        width: 100%;
        border: none;
        background: transparent;
        padding: 0.25rem;
        font-size: 0.85rem;
        font-family: inherit;
        resize: none;
    }

    .catatan-table input:focus,
    .catatan-table textarea:focus {
        outline: none;
        background: #fef9c3;
    }

    /* Size Chart */
    .size-chart-section {
        margin-bottom: 1.5rem;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        overflow: hidden;
    }

    .chart-title {
        background: #f3f4f6;
        padding: 0.5rem 1rem;
        font-weight: 600;
        font-size: 0.9rem;
        color: #374151;
        border-bottom: 1px solid #d1d5db;
    }

    .size-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8rem;
    }

    .size-table th,
    .size-table td {
        border: 1px solid #d1d5db;
        padding: 0.4rem;
        text-align: center;
    }

    .size-table th {
        background: #f9fafb;
        font-weight: 600;
        color: #374151;
    }

    .size-table .col-ukuran {
        width: 80px;
    }

    .size-table .col-jum {
        width: 50px;
        background: #dbeafe;
    }

    .size-table .col-total {
        width: 60px;
        background: #d1fae5;
    }

    .size-table .row-label {
        background: #f9fafb;
        font-weight: 500;
    }

    .size-table input {
        width: 100%;
        border: none;
        text-align: center;
        padding: 0.25rem;
        font-size: 0.8rem;
        background: transparent;
    }

    .size-table input:focus {
        outline: none;
        background: #fef9c3;
    }

    .size-table input::-webkit-inner-spin-button,
    .size-table input::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .size-table input[type=number] {
        -moz-appearance: textfield;
    }

    .size-table .jum {
        background: #dbeafe;
        font-weight: 600;
        color: #1d4ed8;
    }

    .size-table .total {
        background: #d1fae5;
        font-weight: 700;
        color: #059669;
        font-size: 1rem;
        vertical-align: middle;
    }

    /* Print Styles */
    @media print {
        @page {
            size: A4 landscape;
            margin: 5mm;
        }

        body {
            background: white !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        .page-header,
        .btn,
        .change-btn,
        .upload-placeholder {
            display: none !important;
        }

        .dso-document {
            box-shadow: none;
            width: 100%;
            max-width: 100%;
            padding: 0;
            margin: 0;
        }

        /* Enforce table borders visibility */
        .spec-table td,
        .catatan-table td,
        .size-table td,
        .size-table th,
        .info-table .value-inv,
        .info-table .value-due,
        .tampak-depan-section,
        .size-chart-section {
            border-color: #9ca3af !important;
        }

        /* Remove input borders for cleaner print */
        .spec-table input,
        .catatan-table input,
        .catatan-table textarea,
        .size-table input,
        .info-table input {
            border: none !important;
            background: transparent !important;
            box-shadow: none !important;
        }
    }

    /* Responsive */
    @media (max-width: 900px) {
        .dso-header {
            grid-template-columns: 1fr;
            text-align: center;
            gap: 1rem;
        }

        .logo-box {
            justify-content: center;
        }

        .dso-info {
            display: flex;
            justify-content: center;
        }

        .spec-table td.spacer {
            display: none;
        }
    }
</style>

<script>
    // Calculate Dewasa JUM and TOTAL
    function calcDewasa() {
        const sizes = ['xs', 's', 'm', 'l', 'xl', 'xxl', 'x3l', 'x4l', 'x5l'];
        let jumPendek = 0, jumPanjang = 0;

        sizes.forEach(size => {
            jumPendek += parseInt(document.querySelector(`[name="dewasa_pendek_${size}"]`)?.value) || 0;
            jumPanjang += parseInt(document.querySelector(`[name="dewasa_panjang_${size}"]`)?.value) || 0;
        });

        document.getElementById('jumDewasaPendek').textContent = jumPendek;
        document.getElementById('jumDewasaPanjang').textContent = jumPanjang;
        document.getElementById('totalDewasa').textContent = jumPendek + jumPanjang;
    }

    // Calculate Anak JUM and TOTAL
    function calcAnak() {
        const sizes = ['xs', 's', 'm', 'l', 'xl', 'xxl', 'x3l', 'x4l', 'x5l'];
        let jumPendek = 0, jumPanjang = 0;

        sizes.forEach(size => {
            jumPendek += parseInt(document.querySelector(`[name="anak_pendek_${size}"]`)?.value) || 0;
            jumPanjang += parseInt(document.querySelector(`[name="anak_panjang_${size}"]`)?.value) || 0;
        });

        document.getElementById('jumAnakPendek').textContent = jumPendek;
        document.getElementById('jumAnakPanjang').textContent = jumPanjang;
        document.getElementById('totalAnak').textContent = jumPendek + jumPanjang;
    }

    // Upload Gambar Depan
    async function uploadGambarDepan(input) {
        const file = input.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);
        formData.append('image_type', 'depan');

        try {
            showLoading('Mengupload gambar...');
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            const response = await fetch('/api/dso/{{ dso.id }}/images', {
                method: 'POST',
                body: formData,
                credentials: 'same-origin',
                headers: csrfToken ? { 'X-CSRFToken': csrfToken } : {}
            });

            hideLoading();
            if (response.ok) {
                showToast('Gambar berhasil diupload!', 'success');
                location.reload();
            } else {
                const err = await response.json();
                showToast(err.message || 'Upload gagal', 'error');
            }
        } catch (error) {
            hideLoading();
            showToast('Upload gagal', 'error');
        }
    }

    // Save DSO
    async function saveDSO() {
        const dsoData = {
            jenis: document.querySelector('[name="jenis"]').value,
            bahan: document.querySelector('[name="bahan"]').value,
            warna: document.querySelector('[name="warna"]').value,
            sablon: document.querySelector('[name="sablon"]').value,
            posisi: document.querySelector('[name="posisi"]').value,
            acc_1: document.querySelector('[name="acc_1"]').value,
            acc_2: document.querySelector('[name="acc_2"]').value,
            acc_3: document.querySelector('[name="acc_3"]').value,
            acc_4: document.querySelector('[name="acc_4"]').value,
            acc_5: document.querySelector('[name="acc_5"]').value,
            kancing: document.querySelector('[name="kancing"]').value,
            saku: document.querySelector('[name="saku"]').value,
            resleting: document.querySelector('[name="resleting"]').value,
            model_badan_bawah: document.querySelector('[name="model_badan_bawah"]').value,
            catatan_customer_1: document.querySelector('[name="catatan_customer_1"]').value,
            catatan_customer_2: document.querySelector('[name="catatan_customer_2"]').value,
            catatan_customer_3: document.querySelector('[name="catatan_customer_3"]').value,
            catatan_customer_4: document.querySelector('[name="catatan_customer_4"]').value,
            catatan_customer_5: document.querySelector('[name="catatan_customer_5"]').value,
            catatan_customer_6: document.querySelector('[name="catatan_customer_6"]').value,
            label: document.querySelector('[name="label"]').value,
            size_chart_dewasa: {
                pendek_xs: parseInt(document.querySelector('[name="dewasa_pendek_xs"]').value) || 0,
                pendek_s: parseInt(document.querySelector('[name="dewasa_pendek_s"]').value) || 0,
                pendek_m: parseInt(document.querySelector('[name="dewasa_pendek_m"]').value) || 0,
                pendek_l: parseInt(document.querySelector('[name="dewasa_pendek_l"]').value) || 0,
                pendek_xl: parseInt(document.querySelector('[name="dewasa_pendek_xl"]').value) || 0,
                pendek_xxl: parseInt(document.querySelector('[name="dewasa_pendek_xxl"]').value) || 0,
                pendek_x3l: parseInt(document.querySelector('[name="dewasa_pendek_x3l"]').value) || 0,
                pendek_x4l: parseInt(document.querySelector('[name="dewasa_pendek_x4l"]').value) || 0,
                pendek_x5l: parseInt(document.querySelector('[name="dewasa_pendek_x5l"]').value) || 0,
                panjang_xs: parseInt(document.querySelector('[name="dewasa_panjang_xs"]').value) || 0,
                panjang_s: parseInt(document.querySelector('[name="dewasa_panjang_s"]').value) || 0,
                panjang_m: parseInt(document.querySelector('[name="dewasa_panjang_m"]').value) || 0,
                panjang_l: parseInt(document.querySelector('[name="dewasa_panjang_l"]').value) || 0,
                panjang_xl: parseInt(document.querySelector('[name="dewasa_panjang_xl"]').value) || 0,
                panjang_xxl: parseInt(document.querySelector('[name="dewasa_panjang_xxl"]').value) || 0,
                panjang_x3l: parseInt(document.querySelector('[name="dewasa_panjang_x3l"]').value) || 0,
                panjang_x4l: parseInt(document.querySelector('[name="dewasa_panjang_x4l"]').value) || 0,
                panjang_x5l: parseInt(document.querySelector('[name="dewasa_panjang_x5l"]').value) || 0
            },
            size_chart_anak: {
                pendek_xs: parseInt(document.querySelector('[name="anak_pendek_xs"]').value) || 0,
                pendek_s: parseInt(document.querySelector('[name="anak_pendek_s"]').value) || 0,
                pendek_m: parseInt(document.querySelector('[name="anak_pendek_m"]').value) || 0,
                pendek_l: parseInt(document.querySelector('[name="anak_pendek_l"]').value) || 0,
                pendek_xl: parseInt(document.querySelector('[name="anak_pendek_xl"]').value) || 0,
                pendek_xxl: parseInt(document.querySelector('[name="anak_pendek_xxl"]').value) || 0,
                pendek_x3l: parseInt(document.querySelector('[name="anak_pendek_x3l"]').value) || 0,
                pendek_x4l: parseInt(document.querySelector('[name="anak_pendek_x4l"]').value) || 0,
                pendek_x5l: parseInt(document.querySelector('[name="anak_pendek_x5l"]').value) || 0,
                panjang_xs: parseInt(document.querySelector('[name="anak_panjang_xs"]').value) || 0,
                panjang_s: parseInt(document.querySelector('[name="anak_panjang_s"]').value) || 0,
                panjang_m: parseInt(document.querySelector('[name="anak_panjang_m"]').value) || 0,
                panjang_l: parseInt(document.querySelector('[name="anak_panjang_l"]').value) || 0,
                panjang_xl: parseInt(document.querySelector('[name="anak_panjang_xl"]').value) || 0,
                panjang_xxl: parseInt(document.querySelector('[name="anak_panjang_xxl"]').value) || 0,
                panjang_x3l: parseInt(document.querySelector('[name="anak_panjang_x3l"]').value) || 0,
                panjang_x4l: parseInt(document.querySelector('[name="anak_panjang_x4l"]').value) || 0,
                panjang_x5l: parseInt(document.querySelector('[name="anak_panjang_x5l"]').value) || 0
            }
        };

        try {
            await api.put('/dso/{{ dso.id }}', dsoData);
            showToast('DSO berhasil disimpan!', 'success');

            // Wait slightly for UI to settle then print
            setTimeout(() => {
                window.print();
            }, 500);

        } catch (error) {
            showToast(error.message || 'Gagal menyimpan DSO', 'error');
        }
    }
</script>
{% endblock %}