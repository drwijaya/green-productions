{% extends "base.html" %}
{% block title %}Barcode Center{% endblock %}
{% block page_title %}Barcode Center{% endblock %}

{% block content %}
<div class="card-grid">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Scan Barcode</h3>
        </div>
        <div class="card-body text-center">
            <div id="scanner-view"
                style="height:300px;background:var(--gray-100);border-radius:var(--radius);display:flex;align-items:center;justify-content:center;margin-bottom:1rem;">
                <div><i class="fas fa-camera" style="font-size:3rem;color:var(--gray-300)"></i>
                    <p class="text-muted mt-2">Camera Scanner</p>
                </div>
            </div>
            <div class="d-flex gap-2">
                <input type="text" class="form-input" id="manualCode" placeholder="Atau masukkan kode manual...">
                <button class="btn btn-primary" onclick="lookupBarcode()"><i class="fas fa-search"></i></button>
            </div>
            <div id="scanResult" class="mt-3"></div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Generate Barcode</h3>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label class="form-label">Order</label>
                <select class="form-select" id="generateOrderId">
                    <option value="">Pilih Order...</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Type</label>
                <select class="form-select" id="generateType">
                    <option value="order">Order</option>
                    <option value="task">Task</option>
                    <option value="batch">Batch</option>
                </select>
            </div>
            <button class="btn btn-primary w-100" onclick="generateBarcode()"><i class="fas fa-barcode"></i>
                Generate</button>
            <div id="generatedBarcode" class="mt-3 text-center"></div>
        </div>
    </div>
</div>

<style>
    .card-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
    }

    @media (max-width: 1024px) {
        .card-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    async function lookupBarcode() {
        const code = document.getElementById('manualCode').value.trim();
        if (!code) return;
        try {
            const res = await api.get('/barcodes/lookup/' + code);
            document.getElementById('scanResult').innerHTML = `<div class="alert alert-success"><strong>Found:</strong> ${res.data.barcode_type} - Order #${res.data.order_id}</div>`;
        } catch (e) {
            document.getElementById('scanResult').innerHTML = '<div class="alert alert-danger">Barcode tidak ditemukan</div>';
        }
    }

    async function generateBarcode() {
        const orderId = document.getElementById('generateOrderId').value;
        const type = document.getElementById('generateType').value;
        if (!orderId) { showToast('Pilih order', 'error'); return; }
        try {
            const res = await api.post('/barcodes/generate', { order_id: parseInt(orderId), type });
            document.getElementById('generatedBarcode').innerHTML = `<p><strong>${res.data.barcode_value}</strong></p>`;
            showToast('Barcode generated!', 'success');
        } catch (e) {
            showToast(e.message, 'error');
        }
    }

    // Load orders
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const res = await api.get('/orders?per_page=100');
            const select = document.getElementById('generateOrderId');
            res.data.orders.forEach(o => {
                select.innerHTML += `<option value="${o.id}">${o.order_code} - ${o.model}</option>`;
            });
        } catch (e) { }
    });
</script>
{% endblock %}