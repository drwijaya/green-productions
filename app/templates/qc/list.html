{% extends "base.html" %}

{% block title %}QC Monitoring{% endblock %}
{% block page_title %}QC Monitoring{% endblock %}

{% block content %}
<div class="page-header mb-4">
    <div class="page-header-left">
        <p class="text-muted">Checklist QC untuk setiap invoice - pilih invoice untuk melihat dan mengisi checklist</p>
    </div>
</div>

<!-- Orders with QC Checklists -->
<div class="qc-orders-list" id="qcOrdersList">
    <!-- Will be loaded via JavaScript -->
    <div class="loading-state">
        <i class="fas fa-spinner fa-spin"></i> Memuat data...
    </div>
</div>

<!-- QC Checklists Modal -->
<div class="modal-backdrop" id="checklistsModal">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title" id="checklistsModalTitle">
                <i class="fas fa-clipboard-list"></i> QC Checklists
            </h3>
            <button class="modal-close" onclick="closeModal('checklistsModal')">&times;</button>
        </div>
        <div class="modal-body" id="checklistsModalBody">
            <!-- Checklists will be populated here -->
        </div>
    </div>
</div>

<style>
    .qc-orders-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .loading-state {
        text-align: center;
        padding: 3rem;
        color: var(--gray-500);
    }

    /* Order Card */
    .qc-order-card {
        background: var(--bg-primary);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow);
        overflow: hidden;
        transition: all var(--transition);
        cursor: pointer;
    }

    .qc-order-card:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
    }

    .order-card-content {
        display: grid;
        grid-template-columns: auto 1fr auto auto;
        gap: 1.5rem;
        padding: 1.25rem;
        align-items: center;
    }

    .customer-badge {
        background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        color: white;
        padding: 0.75rem 1rem;
        border-radius: var(--radius);
        font-weight: 600;
        text-align: center;
        min-width: 100px;
    }

    .customer-name {
        font-size: 0.875rem;
    }

    .order-details {
        display: flex;
        flex-direction: column;
    }

    .order-code {
        font-size: 0.75rem;
        color: var(--gray-500);
        font-weight: 600;
    }

    .order-model {
        font-size: 1.125rem;
        font-weight: 700;
        margin: 0;
    }

    .order-qty {
        font-size: 0.875rem;
        color: var(--gray-500);
    }

    /* QC Progress Summary */
    .qc-progress-summary {
        display: flex;
        gap: 0.5rem;
    }

    .qc-status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--gray-200);
    }

    .qc-status-dot.filled {
        background: #10B981;
    }

    .qc-status-dot.pending {
        background: #F59E0B;
    }

    .view-btn {
        padding: 0.75rem 1.5rem;
        background: var(--primary);
        color: white;
        border-radius: var(--radius);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all var(--transition);
    }

    .view-btn:hover {
        background: var(--primary-dark);
        transform: scale(1.02);
    }

    /* Modal Checklists */
    .modal-lg {
        max-width: 800px;
    }

    .checklists-grid {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .checklist-item {
        background: var(--gray-50);
        border-radius: var(--radius);
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-left: 4px solid var(--gray-300);
        transition: all var(--transition);
    }

    .checklist-item:hover {
        background: var(--gray-100);
    }

    .checklist-item.status-pending {
        border-left-color: var(--gray-400);
    }

    .checklist-item.status-pass {
        border-left-color: #10B981;
    }

    .checklist-item.status-fail {
        border-left-color: #EF4444;
    }

    .checklist-item.status-conditional_pass {
        border-left-color: #F59E0B;
    }

    .checklist-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .process-icon {
        width: 40px;
        height: 40px;
        border-radius: var(--radius);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }

    .process-icon.cutting {
        background: #DBEAFE;
        color: #1E40AF;
    }

    .process-icon.sewing {
        background: #FEF3C7;
        color: #92400E;
    }

    .process-icon.sablon {
        background: #FCE7F3;
        color: #9D174D;
    }

    .process-icon.finishing {
        background: #E0E7FF;
        color: #3730A3;
    }

    .process-icon.packing {
        background: #D1FAE5;
        color: #065F46;
    }

    .checklist-name {
        font-weight: 600;
    }

    .checklist-status {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .result-badge {
        padding: 0.25rem 0.75rem;
        border-radius: var(--radius-sm);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .result-badge.pending {
        background: var(--gray-200);
        color: var(--gray-600);
    }

    .result-badge.pass {
        background: #D1FAE5;
        color: #065F46;
    }

    .result-badge.fail {
        background: #FEE2E2;
        color: #991B1B;
    }

    .result-badge.conditional_pass {
        background: #FEF3C7;
        color: #92400E;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--gray-500);
    }

    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    .empty-state-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .order-card-content {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .customer-badge {
            text-align: left;
        }

        .qc-progress-summary {
            justify-content: center;
        }
    }
</style>

<script>
    const processIcons = {
        'cutting': 'fa-cut',
        'sewing': 'fa-tshirt',
        'sablon': 'fa-paint-roller',
        'finishing': 'fa-magic',
        'packing': 'fa-box'
    };

    document.addEventListener('DOMContentLoaded', () => {
        loadOrders();
    });

    async function loadOrders() {
        const container = document.getElementById('qcOrdersList');

        try {
            // Get all orders that are in_production or completed
            const response = await api.get('/orders?per_page=100&status=in_production');
            const completedResponse = await api.get('/orders?per_page=100&status=completed');

            let orders = [...(response.data.orders || []), ...(completedResponse.data.orders || [])];

            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><i class="fas fa-clipboard-check"></i></div>
                        <div class="empty-state-title">Belum ada invoice dengan QC checklist</div>
                        <p>Invoice dengan status "In Production" atau "Completed" akan muncul di sini</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = orders.map(order => {
                const qcReports = order.qc_reports || [];
                const filledCount = qcReports.filter(r => r.result && r.result !== 'pending').length;

                return `
                    <div class="qc-order-card" onclick="viewChecklists(${order.id}, '${order.order_code}', '${order.model}', '${order.customer ? order.customer.name : '-'}')">
                        <div class="order-card-content">
                            <div class="customer-badge">
                                <span class="customer-name">${order.customer ? order.customer.name : '-'}</span>
                            </div>
                            <div class="order-details">
                                <span class="order-code">${order.order_code}</span>
                                <h4 class="order-model">${order.model}</h4>
                                <span class="order-qty">${order.qty_total} pcs</span>
                            </div>
                            <div class="qc-progress-summary">
                                ${[1, 2, 3, 4, 5].map((_, i) => `<div class="qc-status-dot ${i < filledCount ? 'filled' : (i < 5 ? 'pending' : '')}"></div>`).join('')}
                            </div>
                            <div class="view-btn">
                                <i class="fas fa-clipboard-list"></i>
                                Lihat Checklist
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="empty-state-title">Gagal memuat data</div>
                    <p>${error.message}</p>
                </div>
            `;
        }
    }

    async function viewChecklists(orderId, orderCode, model, customerName) {
        document.getElementById('checklistsModalTitle').innerHTML = `
            <i class="fas fa-clipboard-list"></i> 
            QC Checklists - ${orderCode}
        `;

        const body = document.getElementById('checklistsModalBody');
        body.innerHTML = '<div class="loading-state"><i class="fas fa-spinner fa-spin"></i> Memuat...</div>';
        openModal('checklistsModal');

        try {
            // Get order detail with production tasks
            const response = await api.get(`/orders/${orderId}`);
            const order = response.data;
            const tasks = order.production_tasks || [];

            // Get QC sheets for this order
            const qcResponse = await api.get(`/qc/sheets?order_id=${orderId}`);
            const qcSheets = qcResponse.data.sheets || [];

            // Map QC sheets to tasks - use string keys for consistent comparison
            // Prioritize non-pending results when multiple sheets exist for the same task
            const taskQCMap = {};
            qcSheets.forEach(sheet => {
                if (sheet.production_task_id) {
                    const key = String(sheet.production_task_id);
                    const existing = taskQCMap[key];

                    // Keep this sheet if: no existing, or existing is pending but this one isn't
                    if (!existing || (existing.result === 'pending' && sheet.result !== 'pending')) {
                        taskQCMap[key] = sheet;
                    }
                    // Also prefer newer non-pending sheets over older non-pending ones
                    else if (existing.result !== 'pending' && sheet.result !== 'pending' && sheet.id > existing.id) {
                        taskQCMap[key] = sheet;
                    }
                }
            });

            body.innerHTML = `
                <div class="order-summary" style="margin-bottom: 1.5rem; padding: 1rem; background: var(--gray-50); border-radius: var(--radius);">
                    <strong>${customerName}</strong> - ${model}<br>
                    <small class="text-muted">${order.qty_total} pcs | Deadline: ${order.deadline ? new Date(order.deadline).toLocaleDateString('id-ID') : '-'}</small>
                </div>
                <div class="checklists-grid">
                    ${tasks.map(task => {
                // Use string key for lookup
                const sheet = taskQCMap[String(task.id)];
                // Get result - handle various possible formats
                let result = 'pending';
                if (sheet) {
                    result = sheet.result || 'pending';
                }

                return `
                            <div class="checklist-item status-${result}">
                                <div class="checklist-info">
                                    <div class="process-icon ${task.process}">
                                        <i class="fas ${processIcons[task.process] || 'fa-check'}"></i>
                                    </div>
                                    <div>
                                        <div class="checklist-name">Checklist ${capitalizeFirst(task.process)}</div>
                                        <small class="text-muted">Task #${task.id} ${sheet ? `- QC: ${sheet.inspection_code}` : ''}</small>
                                    </div>
                                </div>
                                <div class="checklist-status">
                                    <span class="result-badge ${result}">${formatResult(result)}</span>
                                    <a href="/qc/${task.id}" class="btn btn-sm btn-primary">
                                        ${result === 'pending' ? '<i class="fas fa-edit"></i> Isi' : '<i class="fas fa-eye"></i> Lihat'}
                                    </a>
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `;
        } catch (error) {
            body.innerHTML = `<div class="empty-state"><p>Gagal memuat: ${error.message}</p></div>`;
        }
    }

    function capitalizeFirst(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function formatResult(result) {
        const labels = {
            'pending': 'Belum diisi',
            'pass': '‚úÖ Pass',
            'fail': '‚ùå Fail',
            'conditional_pass': '‚ö†Ô∏è Conditional',
            'rework': 'üîÑ Rework'
        };
        return labels[result] || result;
    }
</script>
{% endblock %}