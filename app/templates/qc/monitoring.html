{% extends "base.html" %}

{% block title %}QC Monitoring System{% endblock %}
{% block page_title %}QC Monitoring System{% endblock %}

{% block extra_css %}
<!-- Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    /* Modern Dashboard Styling */
    :root {
        --dashboard-gap: 1.5rem;
        --card-radius: 16px;
        --bg-color: #f8fafc;
    }

    .main-content {
        background-color: var(--bg-color);
    }

    /* Tab Navigation Styles */
    .qc-tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        border-bottom: 1px solid var(--gray-200);
        padding-bottom: 0px;
    }

    .qc-tab-btn {
        background: transparent;
        border: none;
        padding: 1rem 1.5rem;
        font-weight: 600;
        color: var(--gray-500);
        cursor: pointer;
        font-size: 1rem;
        position: relative;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .qc-tab-btn.active {
        color: var(--primary);
    }

    .qc-tab-btn.active::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        width: 100%;
        height: 2px;
        background-color: var(--primary);
        border-radius: 2px 2px 0 0;
    }

    .qc-tab-btn:hover:not(.active) {
        color: var(--gray-700);
    }

    /* Tab Content Area */
    .tab-content {
        display: none;
        animation: fadeIn 0.3s ease-in-out;
    }

    .tab-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Dashboard Grid System */
    .dashboard-stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--dashboard-gap);
        margin-bottom: var(--dashboard-gap);
    }

    .charts-row {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: var(--dashboard-gap);
        margin-bottom: var(--dashboard-gap);
    }

    /* Aesthetic Cards */
    .content-card {
        background: white;
        border-radius: var(--card-radius);
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        border: 1px solid var(--gray-100);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .content-card:hover {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
    }

    .stats-card {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: 100%;
    }

    .stats-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .stats-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }

    .stats-value {
        font-size: 2.25rem;
        font-weight: 700;
        color: var(--gray-800);
        line-height: 1;
        margin-bottom: 0.5rem;
    }

    .stats-label {
        font-size: 0.9rem;
        color: var(--gray-500);
        font-weight: 500;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .chart-container {
        position: relative;
        height: 350px;
        width: 100%;
    }

    /* Defect Table Enhancement */
    .table-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        background: white;
        padding: 1.25rem;
        border-radius: var(--card-radius);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        border: 1px solid var(--gray-100);
    }

    .search-box {
        position: relative;
        width: 380px;
    }

    .search-box i {
        position: absolute;
        left: 1.15rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray-400);
        font-size: 0.95rem;
        pointer-events: none;
        transition: color 0.3s ease;
        z-index: 1;
    }

    .search-box input {
        height: 44px;
        padding-left: 3rem;
        padding-right: 1.25rem;
        border-radius: 12px;
        border: 1.5px solid #e5e7eb;
        background-color: #f9fafb;
        font-size: 0.9rem;
        font-weight: 500;
        color: #374151;
        transition: all 0.3s ease;
        box-shadow: none !important;
    }

    .search-box input:focus {
        background-color: #ffffff;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1) !important;
    }

    .search-box input:focus~i {
        color: var(--primary);
    }

    .search-box input::placeholder {
        color: #9ca3af;
        font-weight: 400;
    }

    .status-badge {
        padding: 0.35em 0.8em;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Modal Styling Fixes */
    .modal-lg {
        max-width: 900px;
        width: 95%;
    }

    /* Input Form Sections */
    .form-section-header {
        background: var(--bg-color);
        padding: 0.75rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 1rem;
        border-left: 4px solid var(--primary);
    }

    /* Empty State */
    .empty-state-modern {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--gray-400);
    }

    .empty-state-modern i {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: var(--gray-300);
    }

    /* Chart Loading Overlay */
    .chart-container {
        position: relative;
    }

    .chart-loading {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 10;
        border-radius: 8px;
        transition: opacity 0.3s ease;
        backdrop-filter: blur(2px);
    }

    .loading-spinner {
        width: 30px;
        height: 30px;
        border: 3px solid #e5e7eb;
        border-top: 3px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 0.5rem;
    }

    .loading-text {
        font-size: 0.875rem;
        color: #6b7280;
        font-weight: 500;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    h4 i,
    h5 i {
        margin-right: 0.5rem;
    }

    .btn-close-custom {
        background: transparent;
        border: none;
        font-size: 1.25rem;
        color: #94a3b8;
        transition: color 0.2s;
    }

    .btn-close-custom:hover {
        color: #334155;
    }

    .form-control-plaintext {
        outline: none;
    }

    .ls-1 {
        letter-spacing: 0.05em;
    }

    /* Ensure analytics tab doesn't overflow */
    #tab-analytics {
        max-width: 100%;
        overflow-x: hidden;
    }

    @media (max-width: 768px) {
        .dashboard-stats-grid {
            grid-template-columns: 1fr 1fr;
        }

        .charts-row {
            grid-template-columns: 1fr;
        }

        .qc-tabs {
            flex-wrap: wrap;
        }

        .qc-tab-btn {
            flex: 1;
            justify-content: center;
        }
    }

    /* ============================================
       Status Filter Tabs
       ============================================ */
    .defect-status-tabs {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        padding: 0.5rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .status-tab {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.25rem;
        border: none;
        background: transparent;
        border-radius: 8px;
        font-weight: 500;
        color: var(--gray-600);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .status-tab:hover {
        background: var(--gray-100);
        color: var(--gray-800);
    }

    .status-tab.active {
        background: var(--primary);
        color: white;
        box-shadow: 0 2px 8px rgba(22, 163, 74, 0.3);
    }

    .status-tab i {
        font-size: 0.9rem;
    }

    .tab-count {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 22px;
        height: 22px;
        padding: 0 6px;
        border-radius: 11px;
        font-size: 0.75rem;
        font-weight: 600;
        background: var(--gray-200);
        color: var(--gray-600);
    }

    .status-tab.active .tab-count {
        background: rgba(255, 255, 255, 0.25);
        color: white;
    }

    .tab-count-danger {
        background: #FEE2E2;
        color: #DC2626;
    }

    .tab-count-warning {
        background: #FEF3C7;
        color: #D97706;
    }

    .tab-count-success {
        background: #D1FAE5;
        color: #059669;
    }

    .tab-count-secondary {
        background: #E5E7EB;
        color: #6B7280;
    }

    /* ============================================
       Summary Statistics Cards
       ============================================ */
    .summary-card {
        display: flex;
        align-items: center;
        gap: 0.875rem;
        padding: 0.875rem 1.25rem;
        border-radius: 12px;
        background: white;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease;
        border: 1px solid #f1f5f9;
        height: 100%;
    }

    .summary-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border-color: #e2e8f0;
    }

    .summary-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        flex-shrink: 0;
    }

    .summary-content {
        display: flex;
        align-items: baseline;
        gap: 0.5rem;
    }

    .summary-value {
        font-size: 1.25rem;
        font-weight: 700;
        line-height: 1;
        color: #1e293b;
    }

    .summary-label {
        font-size: 0.8rem;
        font-weight: 500;
        color: #64748b;
        white-space: nowrap;
    }

    /* Card Variants */
    .summary-card-total .summary-icon {
        background: #E0F2FE;
        color: #0284C7;
    }

    .summary-card-total .summary-value {
        color: #0284C7;
    }

    .summary-card-open .summary-icon {
        background: #FEE2E2;
        color: #DC2626;
    }

    .summary-card-open .summary-value {
        color: #DC2626;
    }

    .summary-card-time .summary-icon {
        background: #F3E8FF;
        color: #9333EA;
    }

    .summary-card-time .summary-value {
        color: #9333EA;
    }

    .summary-card-critical .summary-icon {
        background: #FEF3C7;
        color: #D97706;
    }

    .summary-card-critical .summary-value {
        color: #D97706;
    }

    /* Quick Action Button in Table */
    .btn-quick-resolve {
        padding: 0.35rem 0.75rem;
        font-size: 0.75rem;
        border-radius: 50px;
        background: #D1FAE5;
        color: #059669;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-quick-resolve:hover {
        background: #059669;
        color: white;
    }

    @media (max-width: 768px) {
        .defect-status-tabs {
            flex-direction: column;
        }

        .summary-card {
            margin-bottom: 0.5rem;
        }
    }

    /* ============================================
       Date Range Picker
       ============================================ */
    .date-range-picker {
        padding: 1rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        border: 1px solid var(--gray-200);
    }

    .preset-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    /* Preset Button Enhancements */
    .preset-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0.5rem 1rem;
        border: 1px solid var(--gray-200);
        background: white;
        border-radius: 10px;
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--gray-600);
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 85px;
    }

    .preset-btn .preset-name {
        font-weight: 600;
        font-size: 0.8rem;
    }

    .preset-btn .preset-date {
        font-size: 0.7rem;
        color: var(--gray-400);
        margin-top: 2px;
    }

    .preset-btn.active .preset-date {
        color: rgba(255, 255, 255, 0.8);
    }

    .preset-btn-calendar {
        flex-direction: row;
        gap: 0.5rem;
    }

    .preset-btn-calendar i {
        font-size: 1rem;
    }

    /* ============================================
       Calendar Picker Modal
       ============================================ */
    .calendar-picker-backdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1050;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.2s ease;
    }

    .calendar-picker-backdrop.show {
        display: flex;
    }

    .calendar-picker-modal {
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        max-width: 700px;
        width: 95%;
        animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .calendar-picker-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--gray-200);
    }

    .calendar-picker-header h6 {
        margin: 0;
        font-weight: 600;
        color: var(--gray-800);
    }

    .btn-close-calendar {
        background: transparent;
        border: none;
        font-size: 1.25rem;
        color: var(--gray-400);
        cursor: pointer;
        transition: color 0.2s;
    }

    .btn-close-calendar:hover {
        color: var(--gray-600);
    }

    .calendar-picker-body {
        padding: 1.5rem;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    .calendar-month {
        min-width: 280px;
    }

    .calendar-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .calendar-nav button {
        background: transparent;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 8px;
        color: var(--gray-600);
        cursor: pointer;
        transition: all 0.2s;
    }

    .calendar-nav button:hover {
        background: var(--gray-100);
        color: var(--primary);
    }

    .calendar-month-label {
        font-weight: 600;
        font-size: 1rem;
        color: var(--gray-800);
    }

    .calendar-weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        margin-bottom: 0.5rem;
    }

    .calendar-weekdays span {
        text-align: center;
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--gray-400);
        padding: 0.5rem 0;
    }

    .calendar-days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
    }

    .calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85rem;
        color: var(--gray-700);
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.15s ease;
        position: relative;
    }

    .calendar-day:hover:not(.empty):not(.disabled) {
        background: #DCFCE7;
        color: #16A34A;
    }

    .calendar-day.empty {
        cursor: default;
    }

    .calendar-day.disabled {
        color: var(--gray-300);
        cursor: not-allowed;
    }

    .calendar-day.in-range {
        background: #F0FDF4;
        border-radius: 0;
    }

    .calendar-day.start-date,
    .calendar-day.end-date {
        background: var(--primary);
        color: white;
        font-weight: 600;
    }

    .calendar-day.start-date {
        border-radius: 8px 0 0 8px;
    }

    .calendar-day.end-date {
        border-radius: 0 8px 8px 0;
    }

    .calendar-day.start-date.end-date {
        border-radius: 8px;
    }

    .calendar-day.today {
        font-weight: 700;
        color: var(--primary);
    }

    .calendar-day.today::after {
        content: '';
        position: absolute;
        bottom: 4px;
        width: 4px;
        height: 4px;
        background: var(--primary);
        border-radius: 50%;
    }

    .calendar-picker-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--gray-200);
        background: var(--gray-50);
        border-radius: 0 0 16px 16px;
    }

    .selected-range {
        font-size: 0.9rem;
        color: var(--gray-600);
    }

    .selected-range strong {
        color: var(--primary);
    }

    .calendar-actions {
        display: flex;
        gap: 0.5rem;
    }

    @media (max-width: 768px) {
        .calendar-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .calendar-month {
            min-width: auto;
        }

        .preset-buttons {
            flex-wrap: wrap;
            justify-content: center;
        }

        .preset-btn {
            min-width: 70px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">Quality Control Center</h2>
        <p class="text-muted">Monitoring kualitas produksi dan manajemen defect terpusat</p>
    </div>
    <div id="dashboardActions">

    </div>
</div>

<!-- Main Tabs -->
<!-- Main Tabs -->
<div class="qc-tabs">
    <button class="qc-tab-btn active" onclick="switchTab('analytics', this)">
        <i class="fas fa-brain"></i> Advanced Analytics
    </button>
    <button class="qc-tab-btn" onclick="switchTab('input', this)">
        <i class="fas fa-clipboard-list"></i> Pencatatan Defect
    </button>
</div>

<!-- ADVANCED ANALYTICS TAB -->
<div id="tab-analytics" class="tab-content active">
    <!-- Header with Date Range Picker and Export Buttons -->
    <div class="analytics-header mb-4">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
            <div>
                <h4 class="mb-1"><i class="fas fa-brain text-primary me-2"></i>Advanced Quality Analytics</h4>
                <p class="text-muted mb-0">Deep insights dari data QC Checklist parameters</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-success" onclick="exportCSV()">
                    <i class="fas fa-file-csv me-1"></i> Export CSV
                </button>
                <button class="btn btn-outline-primary" onclick="exportPDF()">
                    <i class="fas fa-file-pdf me-1"></i> Download Report
                </button>
            </div>
        </div>

        <!-- Date Range Picker -->
        <div class="date-range-picker mt-3">
            <div class="d-flex flex-wrap align-items-center gap-3">
                <!-- Preset Buttons with Date Labels -->
                <div class="preset-buttons">
                    <button class="preset-btn" onclick="setDatePreset('today', this)">
                        <span class="preset-name">Hari Ini</span>
                        <span class="preset-date" id="presetDateToday"></span>
                    </button>
                    <button class="preset-btn active" onclick="setDatePreset('week', this)">
                        <span class="preset-name">7 Hari</span>
                        <span class="preset-date" id="presetDateWeek"></span>
                    </button>
                    <button class="preset-btn" onclick="setDatePreset('month', this)">
                        <span class="preset-name">30 Hari</span>
                        <span class="preset-date" id="presetDateMonth"></span>
                    </button>
                    <button class="preset-btn" onclick="setDatePreset('quarter', this)">
                        <span class="preset-name">90 Hari</span>
                        <span class="preset-date" id="presetDateQuarter"></span>
                    </button>
                    <button class="preset-btn preset-btn-calendar" onclick="openCalendarPicker()">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Pilih Tanggal</span>
                    </button>
                </div>

                <!-- Current Period Label -->
                <div class="period-label">
                    <i class="fas fa-clock text-primary me-1"></i>
                    <span id="periodLabel">7 Hari Terakhir</span>
                </div>
            </div>
        </div>

        <!-- Calendar Picker Modal -->
        <div class="calendar-picker-backdrop" id="calendarPickerBackdrop" onclick="closeCalendarPicker()">
            <div class="calendar-picker-modal" onclick="event.stopPropagation()">
                <div class="calendar-picker-header">
                    <h6><i class="fas fa-calendar-week me-2"></i>Pilih Rentang Tanggal</h6>
                    <button class="btn-close-calendar" onclick="closeCalendarPicker()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="calendar-picker-body">
                    <div class="calendar-grid">
                        <!-- Left Calendar -->
                        <div class="calendar-month" id="calendarLeft">
                            <div class="calendar-nav">
                                <button onclick="navigateCalendar(-1)"><i class="fas fa-chevron-left"></i></button>
                                <span class="calendar-month-label" id="leftMonthLabel">November 2024</span>
                            </div>
                            <div class="calendar-weekdays">
                                <span>MIN</span><span>SEN</span><span>SEL</span><span>RAB</span><span>KAM</span><span>JUM</span><span>SAB</span>
                            </div>
                            <div class="calendar-days" id="leftCalendarDays"></div>
                        </div>
                        <!-- Right Calendar -->
                        <div class="calendar-month" id="calendarRight">
                            <div class="calendar-nav">
                                <span class="calendar-month-label" id="rightMonthLabel">December 2024</span>
                                <button onclick="navigateCalendar(1)"><i class="fas fa-chevron-right"></i></button>
                            </div>
                            <div class="calendar-weekdays">
                                <span>MIN</span><span>SEN</span><span>SEL</span><span>RAB</span><span>KAM</span><span>JUM</span><span>SAB</span>
                            </div>
                            <div class="calendar-days" id="rightCalendarDays"></div>
                        </div>
                    </div>
                </div>
                <div class="calendar-picker-footer">
                    <div class="selected-range">
                        <span id="selectedRangeLabel">Belum ada tanggal dipilih</span>
                    </div>
                    <div class="calendar-actions">
                        <button class="btn btn-outline-secondary btn-sm" onclick="closeCalendarPicker()">Batal</button>
                        <button class="btn btn-primary btn-sm" onclick="applyCalendarRange()">Terapkan</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quality Score + FPY Row -->
    <div class="row mb-4">
        <!-- Quality Score Gauge -->
        <div class="col-md-4">
            <div class="content-card h-100 position-relative overflow-hidden"
                style="background: white; border: 1px solid var(--gray-200);">
                <div class="text-center">
                    <h6 class="mb-4 text-uppercase ls-1 text-muted" style="font-size: 0.75rem; font-weight: 700;">
                        <i class="fas fa-star text-warning me-2"></i>Quality Score
                    </h6>

                    <div class="position-relative d-inline-block mb-3">
                        <svg width="160" height="160" viewBox="0 0 160 160">
                            <!-- Background Circle -->
                            <circle cx="80" cy="80" r="70" stroke="#f1f5f9" stroke-width="12" fill="none" />
                            <!-- Value Circle -->
                            <circle id="scoreCircle" cx="80" cy="80" r="70" stroke="#10B981" stroke-width="12"
                                fill="none" stroke-dasharray="440" stroke-dashoffset="440" stroke-linecap="round"
                                transform="rotate(-90 80 80)" style="transition: stroke-dashoffset 1s ease-out;" />
                        </svg>
                        <div class="position-absolute top-50 start-50 translate-middle text-center">
                            <div id="qualityScoreValue" class="text-gray-900"
                                style="font-size: 2.5rem; font-weight: 800; color: #1e293b;">--</div>
                            <div id="qualityGrade" class="text-muted" style="font-size: 0.85rem; font-weight: 500;">
                                Grade</div>
                        </div>
                    </div>

                    <div class="mt-2">
                        <span id="qualityStatus"
                            class="badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill fw-bold">
                            Loading...
                        </span>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <!-- Process Stage Comparison Radar -->
        <div class="col-md-6">
            <div class="content-card">
                <div class="chart-header">
                    <h5 class="mb-0"><i class="fas fa-project-diagram text-primary me-2"></i>Process Stage Comparison
                    </h5>
                </div>
                <div class="chart-container" style="height: 350px;">
                    <canvas id="processRadarChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Parameter Analysis Bar Chart -->
        <div class="col-md-6">
            <div class="content-card">
                <div class="chart-header">
                    <h5 class="mb-0"><i class="fas fa-chart-bar text-primary me-2"></i>Top Problem Parameters</h5>
                </div>
                <div class="chart-container" style="height: 350px;">
                    <canvas id="paramBarChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Defect Pareto Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="content-card">
                <div class="chart-header">
                    <h5 class="mb-0"><i class="fas fa-chart-bar text-warning me-2"></i>Top Defect Types (Pareto
                        Analysis)</h5>
                </div>
                <div class="chart-container" style="height: 350px;">
                    <canvas id="paretoChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Defect Rate Trend Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="content-card">
                <div class="chart-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line text-info me-2"></i>Defect Rate Trend
                    </h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-primary active" onclick="loadDefectTrend('weekly', this)">Per
                            Minggu</button>
                        <button class="btn btn-outline-primary" onclick="loadDefectTrend('monthly', this)">Per
                            Bulan</button>
                    </div>
                </div>
                <!-- Trend Statistics -->
                <div class="row my-3" id="trendStatsRow">
                    <div class="col-md-3">
                        <div class="p-3 rounded" style="background: #F0FDF4;">
                            <small class="text-muted d-block">Rata-rata</small>
                            <div id="avgDefectRate" class="fw-bold text-success fs-4">--%</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 rounded" style="background: #EFF6FF;">
                            <small class="text-muted d-block">Trend</small>
                            <div id="overallTrend" class="fw-bold text-primary fs-4">--</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 rounded" style="background: #D1FAE5;">
                            <small class="text-muted d-block">Periode Terbaik</small>
                            <div id="bestPeriod" class="fw-bold text-success fs-6">--</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 rounded" style="background: #FEE2E2;">
                            <small class="text-muted d-block">Periode Terburuk</small>
                            <div id="worstPeriod" class="fw-bold text-danger fs-6">--</div>
                        </div>
                    </div>
                </div>
                <div class="chart-container" style="height: 350px; position: relative;">
                    <div class="chart-loading" id="trendChartLoading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Memuat data trend...</div>
                    </div>
                    <canvas id="defectRateTrendChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Parameter Heatmap Table -->
    <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0"><i class="fas fa-th text-primary me-2"></i>Parameter Analysis Detail</h5>
            <span class="badge bg-primary" id="analysisCount">0 parameters</span>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle" id="parameterTable">
                <thead class="bg-light">
                    <tr>
                        <th>Stage</th>
                        <th>Parameter</th>
                        <th class="text-end">Total Checked</th>
                        <th class="text-end">Total NG</th>
                        <th class="text-end">NG Rate</th>
                        <th class="text-center">Status</th>
                        <th class="text-end">Std Dev</th>
                    </tr>
                </thead>
                <tbody id="parameterTableBody">
                    <tr>
                        <td colspan="7" class="text-center py-4 text-muted">
                            <i class="fas fa-spinner fa-spin me-2"></i>Loading analytics...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- INPUT & DATA TAB -->
<div id="tab-input" class="tab-content">
    <!-- Status Tabs -->
    <div class="defect-status-tabs mb-4">
        <button class="status-tab" data-status="" onclick="setStatusFilter(this, '')">
            <i class="fas fa-list-ul"></i>
            <span>Semua</span>
            <span class="tab-count" id="countAll">0</span>
        </button>
        <button class="status-tab active" data-status="open" onclick="setStatusFilter(this, 'open')">
            <i class="fas fa-exclamation-circle"></i>
            <span>Open</span>
            <span class="tab-count tab-count-danger" id="countOpen">0</span>
        </button>
        <button class="status-tab" data-status="in_progress" onclick="setStatusFilter(this, 'in_progress')">
            <i class="fas fa-spinner"></i>
            <span>In Progress</span>
            <span class="tab-count tab-count-warning" id="countInProgress">0</span>
        </button>
        <button class="status-tab" data-status="resolved" onclick="setStatusFilter(this, 'resolved')">
            <i class="fas fa-check-circle"></i>
            <span>Resolved</span>
            <span class="tab-count tab-count-success" id="countResolved">0</span>
        </button>
        <button class="status-tab" data-status="closed" onclick="setStatusFilter(this, 'closed')">
            <i class="fas fa-archive"></i>
            <span>Closed</span>
            <span class="tab-count tab-count-secondary" id="countClosed">0</span>
        </button>
    </div>

    <!-- Summary Statistics Cards -->
    <div class="row mb-4" id="defectSummaryCards">
        <div class="col-md-3">
            <div class="summary-card summary-card-total">
                <div class="summary-icon"><i class="fas fa-clipboard-list"></i></div>
                <div class="summary-content">
                    <div class="summary-value" id="statTotalDefects">0</div>
                    <div class="summary-label">Total Defects</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-card summary-card-open">
                <div class="summary-icon"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="summary-content">
                    <div class="summary-value" id="statOpenIssues">0</div>
                    <div class="summary-label">Open Issues</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-card summary-card-time">
                <div class="summary-icon"><i class="fas fa-clock"></i></div>
                <div class="summary-content">
                    <div class="summary-value" id="statAvgResolution">-</div>
                    <div class="summary-label">Avg. Resolution</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-card summary-card-critical">
                <div class="summary-icon"><i class="fas fa-fire"></i></div>
                <div class="summary-content">
                    <div class="summary-value" id="statCriticalMajor">0</div>
                    <div class="summary-label">Critical + Major</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Table Controls -->
    <div class="table-controls">
        <div class="d-flex gap-3 align-items-center flex-grow-1">
            <div class="search-box">
                <input type="text" class="form-control" id="tableSearch"
                    placeholder="Cari No. Order, Produk, atau Defect..." onkeyup="debounce(loadDefects, 500)()">
                <i class="fas fa-search"></i>
            </div>
            <input type="hidden" id="statusFilter" value="open">
            <select class="form-select w-auto" id="stageFilter" onchange="loadDefects()">
                <option value="">Semua Tahapan</option>
                <option value="Cutting">Cutting</option>
                <option value="Sewing">Sewing</option>
                <option value="Sablon">Sablon</option>
                <option value="Finishing">Finishing</option>
                <option value="QC Akhir">QC Akhir</option>
            </select>
        </div>
        <button class="btn btn-primary" onclick="openDefectModal()">
            <i class="fas fa-plus-circle"></i> Tambah Catatan Defect
        </button>
    </div>

    <div class="content-card p-0 overflow-hidden">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4">Tanggal</th>
                        <th>Konteks Produk</th>
                        <th>Detail Defect</th>
                        <th>Tahapan</th>
                        <th>Penanggung Jawab</th>
                        <th>Status</th>
                        <th class="text-end pe-4">Aksi</th>
                    </tr>
                </thead>
                <tbody id="defectTableBody">
                    <tr>
                        <td colspan="7" class="text-center p-5">Memuat data...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>



<!-- MODAL FORM INPUT - Modern Green Theme -->
<div class="modal-backdrop" id="defectModal">
    <div class="modal ncr-modal">
        <!-- Modern Header -->
        <div class="ncr-modal-header">
            <div class="ncr-header-content">
                <div class="ncr-header-icon">
                    <i class="fas fa-clipboard-check"></i>
                </div>
                <div class="ncr-header-text">
                    <h4>Laporan Ketidaksesuaian Produk (NCR)</h4>
                    <p>Formulir pencatatan temuan cacat produksi dan tindak lanjut</p>
                </div>
            </div>
            <button class="ncr-close-btn" onclick="closeModal('defectModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Form Body -->
        <div class="ncr-modal-body">
            <input type="hidden" id="defectId" value="">

            <div class="ncr-layout">
                <!-- LEFT SIDEBAR: Product Context -->
                <div class="ncr-sidebar">
                    <!-- Section Label -->
                    <div class="ncr-section-label">
                        <i class="fas fa-box-open"></i>
                        <span>Konteks Produksi</span>
                    </div>

                    <!-- Order Selection -->
                    <div class="ncr-form-group">
                        <label class="ncr-label required">Sumber Order / Task</label>
                        <select class="ncr-select" id="taskSelect"></select>
                        <span class="ncr-helper-text">
                            <i class="fas fa-info-circle"></i>
                            Pilih SPK/Order yang sedang berjalan
                        </span>
                    </div>

                    <!-- Product Info Display -->
                    <div class="ncr-info-card">
                        <div class="ncr-info-row">
                            <span class="ncr-info-label">Customer</span>
                            <input type="text" class="ncr-info-value" id="customerName" readonly placeholder="—">
                        </div>
                        <div class="ncr-info-row">
                            <span class="ncr-info-label">No. Order</span>
                            <input type="text" class="ncr-info-value" id="orderCode" readonly placeholder="—">
                        </div>
                        <div class="ncr-info-row no-border">
                            <span class="ncr-info-label">Produk</span>
                            <input type="text" class="ncr-info-value" id="productName" readonly placeholder="—">
                        </div>
                    </div>

                    <!-- Process Stage Selection -->
                    <div class="ncr-form-group">
                        <label class="ncr-label required">Tahapan Proses (Stage)</label>
                        <div class="ncr-stage-list">
                            <label class="ncr-stage-item">
                                <input type="radio" name="processStage" value="Cutting">
                                <div class="ncr-stage-content">
                                    <span class="ncr-stage-name">Cutting</span>
                                    <span class="ncr-stage-desc">Pemotongan kain</span>
                                </div>
                                <div class="ncr-stage-check"><i class="fas fa-check"></i></div>
                            </label>
                            <label class="ncr-stage-item">
                                <input type="radio" name="processStage" value="Sewing">
                                <div class="ncr-stage-content">
                                    <span class="ncr-stage-name">Sewing</span>
                                    <span class="ncr-stage-desc">Penjahitan & Perakitan</span>
                                </div>
                                <div class="ncr-stage-check"><i class="fas fa-check"></i></div>
                            </label>
                            <label class="ncr-stage-item">
                                <input type="radio" name="processStage" value="Sablon">
                                <div class="ncr-stage-content">
                                    <span class="ncr-stage-name">Sablon / Bordir</span>
                                    <span class="ncr-stage-desc">Aplikasi grafis</span>
                                </div>
                                <div class="ncr-stage-check"><i class="fas fa-check"></i></div>
                            </label>
                            <label class="ncr-stage-item">
                                <input type="radio" name="processStage" value="Finishing">
                                <div class="ncr-stage-content">
                                    <span class="ncr-stage-name">Finishing</span>
                                    <span class="ncr-stage-desc">Buang benang, setrika, packing</span>
                                </div>
                                <div class="ncr-stage-check"><i class="fas fa-check"></i></div>
                            </label>
                            <label class="ncr-stage-item">
                                <input type="radio" name="processStage" value="QC Akhir">
                                <div class="ncr-stage-content">
                                    <span class="ncr-stage-name">QC Akhir</span>
                                    <span class="ncr-stage-desc">Pemeriksaan final sebelum kirim</span>
                                </div>
                                <div class="ncr-stage-check"><i class="fas fa-check"></i></div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- RIGHT MAIN CONTENT -->
                <div class="ncr-main">
                    <!-- Section 1: Detail Temuan -->
                    <div class="ncr-form-section">
                        <div class="ncr-section-header">
                            <div class="ncr-step-number">1</div>
                            <div class="ncr-step-info">
                                <h6>Detail Temuan Defect</h6>
                                <p>Informasi dasar mengenai temuan cacat</p>
                            </div>
                        </div>

                        <div class="ncr-fields-grid">
                            <div class="ncr-field half">
                                <label class="ncr-label required">Tanggal Temuan</label>
                                <input type="date" class="ncr-input" id="findingDate">
                            </div>
                            <div class="ncr-field half">
                                <label class="ncr-label">Lokasi / Line / Stasiun</label>
                                <input type="text" class="ncr-input" id="station" list="stationList"
                                    placeholder="Ex: Line Sewing 2, Meja 4">
                                <datalist id="stationList">
                                    <option value="Cutting Area">
                                    <option value="Sewing Line 1">
                                    <option value="Sewing Line 2">
                                    <option value="Sablon / Bordir">
                                    <option value="Finishing Area">
                                    <option value="QC Final Station">
                                    <option value="Packing Area">
                                    <option value="Gudang Bahan">
                                </datalist>
                            </div>
                            <div class="ncr-field two-thirds">
                                <label class="ncr-label required">Jenis Defect</label>
                                <div class="ncr-input-icon">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <input type="text" class="ncr-input" id="defectType"
                                        placeholder="Contoh: Jahitan Loncat, Bolong, Noda Oli...">
                                </div>
                            </div>
                            <div class="ncr-field one-third">
                                <label class="ncr-label required">Jumlah (Qty)</label>
                                <input type="number" class="ncr-input ncr-input-qty" id="defectQty" value="1" min="1">
                            </div>
                            <div class="ncr-field full">
                                <label class="ncr-label">Keterangan Tambahan</label>
                                <textarea class="ncr-textarea" id="defectDescription" rows="2"
                                    placeholder="Deskripsikan posisi defect atau detail visual lainnya..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Penanganan -->
                    <div class="ncr-form-section">
                        <div class="ncr-section-header">
                            <div class="ncr-step-number">2</div>
                            <div class="ncr-step-info">
                                <h6>Rencana Penanganan (Rework)</h6>
                                <p>Tindakan perbaikan yang akan dilakukan</p>
                            </div>
                        </div>

                        <div class="ncr-fields-grid">
                            <div class="ncr-field full">
                                <label class="ncr-label">Tindakan Perbaikan</label>
                                <textarea class="ncr-textarea" id="actionTaken" rows="2"
                                    placeholder="Apa yang harus dilakukan untuk memperbaiki? (Ex: Bongkar jahitan samping, Cuci ulang spot noda)"></textarea>
                            </div>
                            <div class="ncr-field full">
                                <label class="ncr-label">Penanggung Jawab (Employee)</label>
                                <select class="ncr-select" id="responsibleDept" style="width: 100%"></select>
                            </div>
                            <div class="ncr-field full">
                                <label class="ncr-label">Target Selesai</label>
                                <input type="date" class="ncr-input" id="targetDate">
                            </div>
                        </div>
                    </div>

                    <!-- Section 3: Verifikasi -->
                    <div class="ncr-form-section ncr-verification">
                        <div class="ncr-section-header">
                            <div class="ncr-step-number">3</div>
                            <div class="ncr-step-info">
                                <h6>Verifikasi & Status Akhir</h6>
                                <p>Hasil pemeriksaan dan status tiket</p>
                            </div>
                        </div>

                        <div class="ncr-fields-grid">
                            <div class="ncr-field half">
                                <label class="ncr-label">Hasil Verifikasi QC</label>
                                <div class="ncr-toggle-group">
                                    <label class="ncr-toggle-btn ncr-toggle-success">
                                        <input type="radio" name="verificationResult" id="v_ok" value="Sesuai">
                                        <span><i class="fas fa-check"></i> Sesuai (OK)</span>
                                    </label>
                                    <label class="ncr-toggle-btn ncr-toggle-danger">
                                        <input type="radio" name="verificationResult" id="v_fail" value="Tidak Sesuai">
                                        <span><i class="fas fa-times"></i> Gagal (Fail)</span>
                                    </label>
                                </div>
                            </div>
                            <div class="ncr-field one-third">
                                <label class="ncr-label">Status Tiket</label>
                                <select class="ncr-select" id="finalStatus">
                                    <option value="open">Open - Belum Selesai</option>
                                    <option value="in_progress">In Progress - Sedang Dikerjakan</option>
                                    <option value="resolved">Resolved - Selesai Diperbaiki</option>
                                    <option value="closed">Closed - Final (Arsip)</option>
                                </select>
                            </div>
                            <div class="ncr-field one-third">
                                <label class="ncr-label">Tanggal Resolusi</label>
                                <input type="date" class="ncr-input" id="resolutionDate">
                            </div>
                            <div class="ncr-field full">
                                <label class="ncr-label">Catatan Verifikasi</label>
                                <input type="text" class="ncr-input" id="verificationNotes"
                                    placeholder="Tambahkan catatan verifikasi di sini...">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modern Footer -->
        <div class="ncr-modal-footer">
            <button class="ncr-btn ncr-btn-cancel" onclick="closeModal('defectModal')">
                <i class="fas fa-times"></i> Batal
            </button>
            <button class="ncr-btn ncr-btn-save" onclick="saveDefect()">
                <i class="fas fa-save"></i> Simpan Laporan
            </button>
        </div>
    </div>
</div>

<style>
    /* ========================================
       NCR MODAL - MODERN GREEN THEME
       No gradients, no whitespace, premium feel
       ======================================== */

    .ncr-modal {
        width: 95%;
        max-width: 1140px;
        background: #ffffff;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        display: flex;
        flex-direction: column;
        max-height: 92vh;
    }

    /* Header */
    .ncr-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 28px;
        background: #059669;
        border-bottom: none;
    }

    .ncr-header-content {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .ncr-header-icon {
        width: 52px;
        height: 52px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: #ffffff;
    }

    .ncr-header-text h4 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 700;
        color: #ffffff;
        letter-spacing: -0.01em;
    }

    .ncr-header-text p {
        margin: 4px 0 0 0;
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.8);
    }

    .ncr-close-btn {
        width: 40px;
        height: 40px;
        border: none;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 10px;
        color: #ffffff;
        font-size: 1.125rem;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .ncr-close-btn:hover {
        background: rgba(255, 255, 255, 0.25);
    }

    /* Body */
    .ncr-modal-body {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .ncr-layout {
        display: flex;
        min-height: 100%;
    }

    /* Sidebar */
    .ncr-sidebar {
        width: 340px;
        min-width: 340px;
        background: #f8fafb;
        padding: 24px;
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .ncr-section-label {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #059669;
    }

    .ncr-section-label i {
        font-size: 0.875rem;
    }

    /* Form Groups */
    .ncr-form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .ncr-label {
        font-size: 0.8125rem;
        font-weight: 600;
        color: #374151;
        margin: 0;
    }

    .ncr-label.required::after {
        content: ' *';
        color: #dc2626;
    }

    .ncr-select,
    .ncr-input {
        width: 100%;
        padding: 12px 14px;
        border: 1.5px solid #d1d5db;
        border-radius: 10px;
        font-size: 0.875rem;
        color: #1f2937;
        background: #ffffff;
        transition: border-color 0.2s, box-shadow 0.2s;
        outline: none;
    }

    .ncr-select:focus,
    .ncr-input:focus {
        border-color: #059669;
        box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.15);
    }

    .ncr-textarea {
        width: 100%;
        padding: 12px 14px;
        border: 1.5px solid #d1d5db;
        border-radius: 10px;
        font-size: 0.875rem;
        color: #1f2937;
        background: #ffffff;
        transition: border-color 0.2s, box-shadow 0.2s;
        outline: none;
        resize: vertical;
        font-family: inherit;
    }

    .ncr-textarea:focus {
        border-color: #059669;
        box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.15);
    }

    .ncr-helper-text {
        font-size: 0.75rem;
        color: #6b7280;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .ncr-helper-text i {
        font-size: 0.7rem;
        color: #9ca3af;
    }

    /* Info Card */
    .ncr-info-card {
        background: #ffffff;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        overflow: hidden;
    }

    .ncr-info-row {
        padding: 14px 16px;
        border-bottom: 1px solid #f3f4f6;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .ncr-info-row.no-border {
        border-bottom: none;
    }

    .ncr-info-label {
        font-size: 0.6875rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #9ca3af;
    }

    .ncr-info-value {
        border: none;
        background: transparent;
        padding: 0;
        font-size: 0.9375rem;
        font-weight: 600;
        color: #111827;
        width: 100%;
        outline: none;
    }

    .ncr-info-value::placeholder {
        color: #d1d5db;
    }

    /* Stage List */
    .ncr-stage-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .ncr-stage-item {
        display: flex;
        align-items: center;
        padding: 12px 14px;
        background: #ffffff;
        border: 1.5px solid #e5e7eb;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }

    .ncr-stage-item:hover {
        border-color: #cbd5e1;
        background: #fafafa;
    }

    .ncr-stage-item input[type="radio"] {
        display: none;
    }

    .ncr-stage-content {
        flex: 1;
    }

    .ncr-stage-name {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: #1f2937;
    }

    .ncr-stage-desc {
        display: block;
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 2px;
    }

    .ncr-stage-check {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid #d1d5db;
        display: flex;
        align-items: center;
        justify-content: center;
        color: transparent;
        transition: all 0.2s;
        font-size: 0.7rem;
    }

    .ncr-stage-item:has(input:checked) {
        border-color: #059669;
        background: #ecfdf5;
    }

    .ncr-stage-item:has(input:checked) .ncr-stage-name {
        color: #059669;
    }

    .ncr-stage-item:has(input:checked) .ncr-stage-check {
        border-color: #059669;
        background: #059669;
        color: #ffffff;
    }

    /* Main Content */
    .ncr-main {
        flex: 1;
        padding: 28px;
        background: #ffffff;
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    /* Form Sections */
    .ncr-form-section {
        padding-bottom: 24px;
        border-bottom: 1px solid #f3f4f6;
    }

    .ncr-form-section:last-child {
        padding-bottom: 0;
        border-bottom: none;
    }

    .ncr-form-section.ncr-verification {
        background: #f8fafb;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #e5e7eb;
        margin-top: 4px;
    }

    .ncr-section-header {
        display: flex;
        align-items: flex-start;
        gap: 14px;
        margin-bottom: 20px;
    }

    .ncr-step-number {
        width: 32px;
        height: 32px;
        min-width: 32px;
        background: #059669;
        color: #ffffff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        font-weight: 700;
    }

    .ncr-step-info h6 {
        margin: 0;
        font-size: 0.9375rem;
        font-weight: 700;
        color: #111827;
    }

    .ncr-step-info p {
        margin: 3px 0 0 0;
        font-size: 0.8125rem;
        color: #6b7280;
    }

    /* Fields Grid */
    .ncr-fields-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
    }

    .ncr-field {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .ncr-field.full {
        width: 100%;
    }

    .ncr-field.half {
        width: calc(50% - 8px);
    }

    .ncr-field.two-thirds {
        width: calc(66.666% - 8px);
    }

    .ncr-field.one-third {
        width: calc(33.333% - 8px);
    }

    /* Input with Icon */
    .ncr-input-icon {
        position: relative;
    }

    .ncr-input-icon i {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: #f59e0b;
        font-size: 0.875rem;
    }

    .ncr-input-icon .ncr-input {
        padding-left: 40px;
    }

    .ncr-input-qty {
        text-align: center;
        font-weight: 700;
        font-size: 1.125rem;
    }

    /* Toggle Buttons */
    .ncr-toggle-group {
        display: flex;
        gap: 10px;
    }

    .ncr-toggle-btn {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 12px 16px;
        border: 1.5px solid #d1d5db;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s;
        background: #ffffff;
    }

    .ncr-toggle-btn input {
        display: none;
    }

    .ncr-toggle-btn span {
        font-size: 0.875rem;
        font-weight: 600;
        color: #6b7280;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .ncr-toggle-btn:hover {
        border-color: #9ca3af;
    }

    .ncr-toggle-success:has(input:checked) {
        border-color: #059669;
        background: #ecfdf5;
    }

    .ncr-toggle-success:has(input:checked) span {
        color: #059669;
    }

    .ncr-toggle-danger:has(input:checked) {
        border-color: #dc2626;
        background: #fef2f2;
    }

    .ncr-toggle-danger:has(input:checked) span {
        color: #dc2626;
    }

    /* Footer */
    .ncr-modal-footer {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 12px;
        padding: 18px 28px;
        background: #f9fafb;
        border-top: 1px solid #e5e7eb;
    }

    .ncr-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        border-radius: 10px;
        font-size: 0.9375rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
    }

    .ncr-btn-cancel {
        background: #ffffff;
        color: #6b7280;
        border: 1.5px solid #d1d5db;
    }

    .ncr-btn-cancel:hover {
        background: #f3f4f6;
        color: #374151;
    }

    .ncr-btn-save {
        background: #059669;
        color: #ffffff;
        box-shadow: 0 4px 14px rgba(5, 150, 105, 0.25);
    }

    .ncr-btn-save:hover {
        background: #047857;
        box-shadow: 0 6px 20px rgba(5, 150, 105, 0.35);
    }

    /* Responsive */
    @media (max-width: 992px) {
        .ncr-layout {
            flex-direction: column;
        }

        .ncr-sidebar {
            width: 100%;
            min-width: 100%;
            border-right: none;
            border-bottom: 1px solid #e5e7eb;
        }

        .ncr-field.half,
        .ncr-field.two-thirds,
        .ncr-field.one-third {
            width: 100%;
        }
    }

    @media (max-width: 576px) {
        .ncr-modal {
            border-radius: 12px;
        }

        .ncr-modal-header {
            padding: 16px 20px;
        }

        .ncr-header-icon {
            width: 44px;
            height: 44px;
            font-size: 1.25rem;
        }

        .ncr-header-text h4 {
            font-size: 1.0625rem;
        }

        .ncr-sidebar,
        .ncr-main {
            padding: 20px;
        }

        .ncr-toggle-group {
            flex-direction: column;
        }

        .ncr-modal-footer {
            flex-direction: column;
            gap: 10px;
        }

        .ncr-btn {
            width: 100%;
            justify-content: center;
        }
    }
</style>

<style>
    /* Radio Card Styling */
    .radio-card input:checked+div .fw-bold {
        color: var(--primary);
    }

    .radio-card {
        border-color: #e2e8f0;
    }

    .radio-card:has(input:checked) {
        border-color: var(--primary);
        background-color: #eff6ff;
    }

    .hover-bg-white:hover {
        background-color: white;
        border-color: #cbd5e1;
    }

    /* Parameter Stats Row */
    .param-stats-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-top: 1.5rem;
    }

    .card-header-simple {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #E5E7EB;
    }

    .card-header-simple .card-title {
        font-size: 0.9rem;
        font-weight: 600;
    }

    /* Parameter List */
    .param-list {
        padding: 0.75rem;
        max-height: 280px;
        overflow-y: auto;
    }

    .param-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        background: #F9FAFB;
        transition: background 0.2s;
    }

    .param-item:hover {
        background: #F3F4F6;
    }

    .param-item:last-child {
        margin-bottom: 0;
    }

    .param-info {
        flex: 1;
    }

    .param-name {
        font-weight: 500;
        font-size: 0.875rem;
        color: #374151;
        margin-bottom: 0.125rem;
    }

    .param-count {
        font-size: 0.75rem;
        color: #6B7280;
    }

    .param-rate {
        font-weight: 600;
        font-size: 0.875rem;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        background: #FEE2E2;
        color: #B91C1C;
    }

    .param-rate.low {
        background: #FEF3C7;
        color: #B45309;
    }

    .param-rate.ok {
        background: #D1FAE5;
        color: #047857;
    }

    /* Stage Breakdown */
    .stage-breakdown {
        padding: 1rem;
    }

    .stage-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.875rem 0;
        border-bottom: 1px solid #F3F4F6;
    }

    .stage-item:last-child {
        border-bottom: none;
    }

    .stage-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .stage-icon.cutting {
        background: #DBEAFE;
        color: #1E40AF;
    }

    .stage-icon.sewing {
        background: #FEF3C7;
        color: #92400E;
    }

    .stage-icon.sablon {
        background: #FCE7F3;
        color: #9D174D;
    }

    .stage-icon.finishing {
        background: #E0E7FF;
        color: #3730A3;
    }

    .stage-info {
        flex: 1;
    }

    .stage-name {
        font-weight: 600;
        font-size: 0.875rem;
        color: #374151;
        margin-bottom: 0.25rem;
    }

    .stage-bar {
        height: 6px;
        background: #E5E7EB;
        border-radius: 3px;
        overflow: hidden;
    }

    .stage-bar-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.5s ease;
    }

    .stage-bar-fill.good {
        background: #10B981;
    }

    .stage-bar-fill.warning {
        background: #F59E0B;
    }

    .stage-bar-fill.bad {
        background: #EF4444;
    }

    .stage-stats {
        text-align: right;
    }

    .stage-rate {
        font-weight: 700;
        font-size: 1rem;
        color: #374151;
    }

    .stage-count {
        font-size: 0.75rem;
        color: #9CA3AF;
    }

    /* Empty State */
    .empty-state-mini {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        color: #9CA3AF;
        gap: 0.5rem;
    }

    .empty-state-mini i {
        font-size: 1.5rem;
    }

    @media (max-width: 1024px) {
        .param-stats-row {
            grid-template-columns: 1fr;
        }
    }

    /* Modern Select2 Styling */
    .select2-container--default .select2-selection--single {
        height: 42px !important;
        background-color: #f9fafb !important;
        border: 1px solid #e5e7eb !important;
        border-radius: 8px !important;
        display: flex !important;
        align-items: center !important;
        padding: 0 10px !important;
        transition: all 0.2s ease !important;
    }

    .select2-container--default.select2-container--focus .select2-selection--single {
        border-color: #10b981 !important;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
        background-color: #fff !important;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        color: #374151 !important;
        font-weight: 500 !important;
        line-height: normal !important;
        padding-left: 0 !important;
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 40px !important;
        right: 10px !important;
    }

    .select2-dropdown {
        border: 1px solid #e5e7eb !important;
        border-radius: 12px !important;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important;
        overflow: hidden !important;
        margin-top: 5px !important;
        z-index: 9999 !important;
    }

    .select2-search--dropdown .select2-search__field {
        border-radius: 6px !important;
        border: 1px solid #e5e7eb !important;
        padding: 8px 12px !important;
    }

    .select2-results__option--highlighted[aria-selected] {
        background-color: #10b981 !important;
    }

    .select2-results__option {
        padding: 10px 15px !important;
        font-size: 0.9rem !important;
    }

    /* Fix for modal z-index */
    .select2-container--open {
        z-index: 1060 !important;
    }
</style>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    let trendChart = null;
    let paretoChart = null;
    let currentPeriod = 'month';

    // ============================================
    // Global Analytics Date Range State
    // ============================================
    let analyticsDateRange = {
        startDate: null,
        endDate: null,
        preset: 'week',
        days: 7
    };

    // Calendar Picker State
    let calendarState = {
        currentMonth: new Date(),
        selectionStart: null,
        selectionEnd: null,
        selecting: false
    };

    const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
        'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

    // Initialize with default 7 days
    function initDateRange() {
        const end = new Date();
        const start = new Date();
        start.setDate(end.getDate() - 7);
        analyticsDateRange.startDate = start;
        analyticsDateRange.endDate = end;
        analyticsDateRange.preset = 'week';
        analyticsDateRange.days = 7;
        updatePresetDateLabels();
        updatePeriodLabel();
    }

    function formatShortDate(date) {
        const d = date.getDate();
        const m = date.getMonth() + 1;
        return `${d}/${m}`;
    }

    function updatePresetDateLabels() {
        const today = new Date();
        const fmtOpts = { day: 'numeric', month: 'short' };

        // Today
        document.getElementById('presetDateToday').textContent = today.toLocaleDateString('id-ID', fmtOpts);

        // 7 Days
        const week = new Date();
        week.setDate(today.getDate() - 7);
        document.getElementById('presetDateWeek').textContent =
            `${formatShortDate(week)} - ${formatShortDate(today)}`;

        // 30 Days
        const month = new Date();
        month.setDate(today.getDate() - 30);
        document.getElementById('presetDateMonth').textContent =
            `${formatShortDate(month)} - ${formatShortDate(today)}`;

        // 90 Days
        const quarter = new Date();
        quarter.setDate(today.getDate() - 90);
        document.getElementById('presetDateQuarter').textContent =
            `${formatShortDate(quarter)} - ${formatShortDate(today)}`;
    }

    function setDatePreset(preset, btn) {
        const end = new Date();
        const start = new Date();
        let days = 7;
        let label = '7 Hari Terakhir';

        switch (preset) {
            case 'today':
                start.setHours(0, 0, 0, 0);
                end.setHours(23, 59, 59, 999);
                days = 1;
                label = 'Hari Ini';
                break;
            case 'week':
                start.setDate(end.getDate() - 7);
                days = 7;
                label = '7 Hari Terakhir';
                break;
            case 'month':
                start.setDate(end.getDate() - 30);
                days = 30;
                label = '30 Hari Terakhir';
                break;
            case 'quarter':
                start.setDate(end.getDate() - 90);
                days = 90;
                label = '90 Hari Terakhir';
                break;
        }

        analyticsDateRange.startDate = start;
        analyticsDateRange.endDate = end;
        analyticsDateRange.preset = preset;
        analyticsDateRange.days = days;

        // Update UI
        document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
        if (btn) btn.classList.add('active');
        updatePeriodLabel();

        // Refresh all analytics
        refreshAllAnalytics();
    }

    // ============================================
    // Calendar Picker Functions
    // ============================================
    function openCalendarPicker() {
        calendarState.currentMonth = new Date();
        calendarState.selectionStart = new Date(analyticsDateRange.startDate);
        calendarState.selectionEnd = new Date(analyticsDateRange.endDate);
        calendarState.selecting = false;

        document.getElementById('calendarPickerBackdrop').classList.add('show');
        renderCalendars();
        updateSelectedRangeLabel();
    }

    function closeCalendarPicker() {
        document.getElementById('calendarPickerBackdrop').classList.remove('show');
    }

    function navigateCalendar(direction) {
        calendarState.currentMonth.setMonth(calendarState.currentMonth.getMonth() + direction);
        renderCalendars();
    }

    function renderCalendars() {
        const leftMonth = new Date(calendarState.currentMonth);
        const rightMonth = new Date(calendarState.currentMonth);
        rightMonth.setMonth(rightMonth.getMonth() + 1);

        document.getElementById('leftMonthLabel').textContent =
            `${monthNames[leftMonth.getMonth()]} ${leftMonth.getFullYear()}`;
        document.getElementById('rightMonthLabel').textContent =
            `${monthNames[rightMonth.getMonth()]} ${rightMonth.getFullYear()}`;

        renderMonthDays('leftCalendarDays', leftMonth);
        renderMonthDays('rightCalendarDays', rightMonth);
    }

    function renderMonthDays(containerId, month) {
        const container = document.getElementById(containerId);
        const year = month.getFullYear();
        const monthIndex = month.getMonth();
        const firstDay = new Date(year, monthIndex, 1).getDay();
        const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        let html = '';

        // Empty cells for days before first of month
        for (let i = 0; i < firstDay; i++) {
            html += '<div class="calendar-day empty"></div>';
        }

        // Days of month
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, monthIndex, day);
            let classes = 'calendar-day';

            if (date.getTime() === today.getTime()) classes += ' today';

            // Check if in range
            if (calendarState.selectionStart && calendarState.selectionEnd) {
                const start = new Date(calendarState.selectionStart);
                const end = new Date(calendarState.selectionEnd);
                start.setHours(0, 0, 0, 0);
                end.setHours(0, 0, 0, 0);

                if (date.getTime() === start.getTime()) classes += ' start-date';
                if (date.getTime() === end.getTime()) classes += ' end-date';
                if (date > start && date < end) classes += ' in-range';
            }

            html += `<div class="${classes}" onclick="selectCalendarDay(${year}, ${monthIndex}, ${day})">${day}</div>`;
        }

        container.innerHTML = html;
    }

    function selectCalendarDay(year, month, day) {
        const date = new Date(year, month, day);

        if (!calendarState.selecting || !calendarState.selectionStart) {
            // First click - set start date
            calendarState.selectionStart = date;
            calendarState.selectionEnd = date;
            calendarState.selecting = true;
        } else {
            // Second click - set end date
            if (date < calendarState.selectionStart) {
                calendarState.selectionEnd = calendarState.selectionStart;
                calendarState.selectionStart = date;
            } else {
                calendarState.selectionEnd = date;
            }
            calendarState.selecting = false;
        }

        renderCalendars();
        updateSelectedRangeLabel();
    }

    function updateSelectedRangeLabel() {
        const label = document.getElementById('selectedRangeLabel');
        if (calendarState.selectionStart && calendarState.selectionEnd) {
            const opts = { day: 'numeric', month: 'short', year: 'numeric' };
            label.innerHTML = `<strong>${calendarState.selectionStart.toLocaleDateString('id-ID', opts)}</strong> - <strong>${calendarState.selectionEnd.toLocaleDateString('id-ID', opts)}</strong>`;
        } else {
            label.textContent = 'Belum ada tanggal dipilih';
        }
    }

    function applyCalendarRange() {
        if (!calendarState.selectionStart || !calendarState.selectionEnd) {
            showToast('Pilih rentang tanggal terlebih dahulu', 'error');
            return;
        }

        analyticsDateRange.startDate = calendarState.selectionStart;
        analyticsDateRange.endDate = calendarState.selectionEnd;
        analyticsDateRange.preset = 'custom';
        analyticsDateRange.days = Math.ceil((calendarState.selectionEnd - calendarState.selectionStart) / (1000 * 60 * 60 * 24)) + 1;

        document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
        updatePeriodLabel();
        closeCalendarPicker();
        refreshAllAnalytics();
    }

    function updatePeriodLabel() {
        const start = analyticsDateRange.startDate;
        const end = analyticsDateRange.endDate;
        const options = { day: 'numeric', month: 'short', year: 'numeric' };
        document.getElementById('periodLabel').textContent =
            `${start.toLocaleDateString('id-ID', options)} - ${end.toLocaleDateString('id-ID', options)}`;
    }

    function getDateParams() {
        return {
            start_date: analyticsDateRange.startDate.toISOString().split('T')[0],
            end_date: analyticsDateRange.endDate.toISOString().split('T')[0]
        };
    }

    function refreshAllAnalytics() {
        loadAnalyticsData();
        loadDefectTrend('weekly');
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Init Date Range
        initDateRange();

        // Init Select2 Logic
        setupSelect2();

        // Init Date
        document.getElementById('findingDate').valueAsDate = new Date();

        // Load Initial Data
        loadAnalyticsData();
        loadDefects();
        loadDefectTrend('weekly');
    });

    // --- Tab Switching ---
    function switchTab(tabName, btn) {
        // Update Buttons
        document.querySelectorAll('.qc-tab-btn').forEach(b => b.classList.remove('active'));
        if (btn) btn.classList.add('active'); // Use the passed button if available

        // Update Content
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`tab-${tabName}`).classList.add('active');

        if (tabName === 'input') {
            loadDefects();
        } else if (tabName === 'analytics') {
            loadAnalyticsData();
        } else {
            loadDashboardData();
        }
    }

    // --- Advanced Analytics Logic ---
    // --- Helper Functions ---
    function showChartLoading(canvasId) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        const container = canvas.parentElement;

        let loader = container.querySelector('.chart-loading');
        if (!loader) {
            loader = document.createElement('div');
            loader.className = 'chart-loading';
            loader.innerHTML = `
                <div class="loading-spinner"></div>
                <div class="loading-text">Memuat Data...</div>
            `;
            container.appendChild(loader);
        }
        loader.style.display = 'flex';
        // Trigger reflow
        void loader.offsetWidth;
        loader.style.opacity = '1';
    }

    function hideChartLoading(canvasId) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        const container = canvas.parentElement;
        const loader = container.querySelector('.chart-loading');
        if (loader) {
            loader.style.opacity = '0';
            setTimeout(() => {
                loader.style.display = 'none';
            }, 300);
        }
    }

    // --- Advanced Analytics Logic ---
    async function loadAnalyticsData() {
        // Get date params from global state
        const { start_date, end_date } = getDateParams();
        const queryStr = `start_date=${start_date}&end_date=${end_date}`;

        // Show Loaders for Charts
        showChartLoading('processRadarChart');
        showChartLoading('paramBarChart');
        showChartLoading('paretoChart');

        try {
            // Use parallel requests for better performance
            const p1 = api.get(`/qc/dashboard/quality-score?${queryStr}`)
                .then(res => {
                    updateQualityScore(res);
                });

            const p3 = api.get(`/qc/dashboard/process-comparison?${queryStr}`)
                .then(res => {
                    renderProcessRadar(res.stages);
                    hideChartLoading('processRadarChart');
                });

            const p4 = api.get(`/qc/dashboard/checklist-analysis?${queryStr}`)
                .then(res => {
                    renderParamBar(res.parameters);
                    hideChartLoading('paramBarChart');
                    updateParamTable(res.parameters);
                    document.getElementById('analysisCount').textContent = res.total_parameters_analyzed + ' parameters';
                });

            const p5 = api.get(`/qc/dashboard/defect-pareto?${queryStr}`)
                .then(res => {
                    renderParetoChart(res.pareto_data);
                    hideChartLoading('paretoChart');
                });

            await Promise.all([p1, p3, p4, p5]);

        } catch (error) {
            console.error('Error loading analytics:', error);
            showToast('Gagal memuat data analytics', 'error');

            // Ensure loaders are hidden on error
            hideChartLoading('processRadarChart');
            hideChartLoading('paramBarChart');
            hideChartLoading('paretoChart');
        }
    }

    function renderParetoChart(data) {
        const canvas = document.getElementById('paretoChart');
        const ctx = canvas.getContext('2d');
        const container = canvas.parentElement;

        if (paretoChart) {
            paretoChart.destroy();
            paretoChart = null;
        }

        // Remove existing empty state if any
        const existingEmpty = container.querySelector('.empty-state-overlay');
        if (existingEmpty) existingEmpty.remove();

        // Handle empty data
        if (!data || data.length === 0) {
            const emptyState = document.createElement('div');
            emptyState.className = 'empty-state-overlay';
            emptyState.style.cssText = 'position: absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; background:rgba(255,255,255,0.9); z-index:5;';
            emptyState.innerHTML = `
                <div class="text-muted mb-2"><i class="fas fa-chart-bar fa-2x"></i></div>
                <div class="text-muted fw-medium">Belum ada data defect untuk ditampilkan</div>
            `;
            container.appendChild(emptyState);
            return;
        }

        const labels = data.map(d => d.type);
        const counts = data.map(d => d.count);
        const percentages = data.map(d => d.cumulative_percentage);

        paretoChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Jumlah Defect',
                        data: counts,
                        backgroundColor: 'rgba(245, 158, 11, 0.7)',
                        borderColor: '#F59E0B',
                        borderWidth: 1,
                        order: 2,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Kumulatif %',
                        data: percentages,
                        type: 'line',
                        borderColor: '#EF4444',
                        borderWidth: 2,
                        pointBackgroundColor: '#EF4444',
                        tension: 0.1,
                        order: 1,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: { position: 'top' }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: true,
                        title: { display: true, text: 'Jumlah Defect' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        min: 0,
                        max: 105,
                        grid: { display: false },
                        title: { display: true, text: 'Persentase Kumulatif (%)' }
                    }
                }
            }
        });
    }

    function updateQualityScore(data) {
        // Update Value & Grade
        animateValue('qualityScoreValue', data.quality_score); // Assuming animateValue handles floats slightly modified or just parseInt
        document.getElementById('qualityScoreValue').textContent = data.quality_score;
        document.getElementById('qualityGrade').textContent = `Grade ${data.grade} (${data.status})`;

        // Update Status Text
        const statusEl = document.getElementById('qualityStatus');
        statusEl.textContent = data.status;
        statusEl.className = 'fw-semibold ' + (data.grade === 'A' || data.grade === 'B' ? 'text-success' : data.grade === 'C' ? 'text-warning' : 'text-danger');

        // Update Circle Progress
        const circle = document.getElementById('scoreCircle');
        const radius = circle.r.baseVal.value;
        const circumference = radius * 2 * Math.PI;
        const offset = circumference - (data.quality_score / 100) * circumference;
        circle.style.strokeDashoffset = offset;

        // Color based on score
        const color = data.quality_score >= 90 ? '#10B981' : data.quality_score >= 70 ? '#F59E0B' : '#EF4444';
        circle.style.stroke = color;
    }

    function updateFPY(data) {
        document.getElementById('fpyValue').textContent = data.fpy + '%';
        animateValue('fpyInspected', data.total_inspected);
        animateValue('fpyPassed', data.total_passed);
        animateValue('fpyFailed', data.total_failed);
    }

    function updateTrend(summary) {
        document.getElementById('currentFpy').textContent = summary.fpy + '%';
        document.getElementById('prevFpy').textContent = (summary.fpy - summary.fpy_change).toFixed(2) + '%'; // Approx/Reverse calc

        const trendEl = document.getElementById('trendChange');
        const indicatorEl = document.getElementById('trendIndicator');
        const change = summary.fpy_change;

        trendEl.textContent = (change >= 0 ? '+' : '') + change + '%';

        if (change >= 0) {
            indicatorEl.className = 'badge bg-success px-3 py-2';
            indicatorEl.innerHTML = `<i class="fas fa-arrow-up me-1"></i> ${trendEl.textContent} vs periode sebelumnya`;
        } else {
            indicatorEl.className = 'badge bg-danger px-3 py-2';
            indicatorEl.innerHTML = `<i class="fas fa-arrow-down me-1"></i> ${trendEl.textContent} vs periode sebelumnya`;
        }
    }

    let processChart = null;
    function renderProcessRadar(stages) {
        const ctx = document.getElementById('processRadarChart').getContext('2d');

        if (processChart) processChart.destroy();

        const labels = stages.map(s => s.name);
        const passRates = stages.map(s => s.pass_rate);
        const ngRates = stages.map(s => s.ng_rate);

        processChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Pass Rate (%)',
                    data: passRates,
                    fill: true,
                    backgroundColor: 'rgba(16, 185, 129, 0.2)',
                    borderColor: 'rgb(16, 185, 129)',
                    pointBackgroundColor: 'rgb(16, 185, 129)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(16, 185, 129)'
                }, {
                    label: 'NG Rate (%)',
                    data: ngRates,
                    fill: true,
                    backgroundColor: 'rgba(239, 68, 68, 0.2)',
                    borderColor: 'rgb(239, 68, 68)',
                    pointBackgroundColor: 'rgb(239, 68, 68)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(239, 68, 68)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        angleLines: { display: false },
                        suggestedMin: 0,
                        suggestedMax: 100
                    }
                }
            }
        });
    }

    let paramBarChart = null;
    function renderParamBar(params) {
        const ctx = document.getElementById('paramBarChart').getContext('2d');

        if (paramBarChart) paramBarChart.destroy();

        // Top 5 problem params
        const topParams = params.slice(0, 5);

        paramBarChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: topParams.map(p => p.parameter),
                datasets: [{
                    label: 'NG Rate (%)',
                    data: topParams.map(p => p.ng_rate),
                    backgroundColor: topParams.map(p => {
                        return p.ng_rate > 2.5 ? 'rgba(239, 68, 68, 0.7)' : 'rgba(245, 158, 11, 0.7)';
                    }),
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { beginAtZero: true }
                }
            }
        });
    }

    function updateParamTable(params) {
        const tbody = document.getElementById('parameterTableBody');
        tbody.innerHTML = '';

        params.forEach(p => {
            const statusClass = p.status === 'critical' ? 'bg-danger text-white' :
                p.status === 'warning' ? 'bg-warning text-dark' : 'bg-success text-white';
            const statusBadge = `<span class="badge ${statusClass}">${p.status.toUpperCase()}</span>`;

            const row = `
                <tr>
                    <td><span class="badge bg-light text-dark border">${p.stage || 'General'}</span></td>
                    <td class="fw-medium">${p.parameter}</td>
                    <td class="text-end">${p.total_checked}</td>
                    <td class="text-end text-danger">${p.total_ng}</td>
                    <td class="text-end fw-bold">${p.ng_rate}%</td>
                    <td class="text-center">${statusBadge}</td>
                    <td class="text-end text-muted">${p.std_dev}</td>
                </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', row);
        });
    }

    async function exportPDF() {
        try {
            showToast('Sedang menyiapkan PDF...', 'info');

            const start = analyticsDateRange.startDate.toISOString().split('T')[0];
            const end = analyticsDateRange.endDate.toISOString().split('T')[0];

            const url = `/api/qc/dashboard/export-pdf?start_date=${start}&end_date=${end}`;

            // Create a temporary link and click it
            const a = document.createElement('a');
            a.href = url;
            a.download = `QC_Report_${start}_to_${end}.pdf`;
            document.body.appendChild(a);
            a.click();
            a.remove();

            showToast('PDF berhasil diunduh', 'success');
        } catch (error) {
            console.error('PDF Export Error:', error);
            showToast('Gagal mengunduh PDF', 'error');
        }
    }

    function exportCSV() {
        const start = analyticsDateRange.startDate.toISOString().split('T')[0];
        const end = analyticsDateRange.endDate.toISOString().split('T')[0];
        window.location.href = `/api/qc/dashboard/export-csv?start_date=${start}&end_date=${end}`;
    }

    // --- Defect Rate Trend Logic ---

    async function loadDefectTrend(period = 'weekly', btn = null) {
        // Update button states
        if (btn) {
            btn.closest('.btn-group').querySelectorAll('.btn')
                .forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // Show loading
        const loader = document.getElementById('trendChartLoading');
        if (loader) loader.style.display = 'flex';

        try {
            const count = period === 'weekly' ? 12 : 12; // 12 weeks or 12 months
            const res = await api.get(`/qc/dashboard/defect-rate-trends?period=${period}&count=${count}`);

            // Update stats
            document.getElementById('avgDefectRate').textContent = res.average_rate.toFixed(2) + '%';
            document.getElementById('overallTrend').innerHTML = getTrendBadge(res.overall_trend);
            document.getElementById('bestPeriod').textContent =
                res.best_period ? `${res.best_period.label} (${res.best_period.defect_rate}%)` : '-';
            document.getElementById('worstPeriod').textContent =
                res.worst_period ? `${res.worst_period.label} (${res.worst_period.defect_rate}%)` : '-';

            // Render chart
            renderTrendChart(res.data_points, period);
        } catch (e) {
            console.error('Failed to load trend:', e);
        } finally {
            if (loader) loader.style.display = 'none';
        }
    }

    function getTrendBadge(trend) {
        const icons = { 'improving': 'fa-arrow-trend-down', 'stable': 'fa-minus', 'declining': 'fa-arrow-trend-up' };
        // Note: For defect rate, 'improving' means going DOWN (less defects)
        // 'declining' means going UP (more defects)
        const colors = { 'improving': 'text-success', 'stable': 'text-secondary', 'declining': 'text-danger' };
        const labels = { 'improving': 'Membaik', 'stable': 'Stabil', 'declining': 'Memburuk' };

        // If trend is not recognized, default to stable
        const t = trend || 'stable';

        return `<i class="fas ${icons[t] || icons.stable} me-1 ${colors[t] || colors.stable}"></i><span class="${colors[t] || colors.stable}">${labels[t] || t}</span>`;
    }

    function renderTrendChart(dataPoints, period) {
        const ctx = document.getElementById('defectRateTrendChart');
        if (!ctx) return;

        if (trendChart) trendChart.destroy();

        // Prepare datasets
        const labels = dataPoints.map(d => d.label);
        const rates = dataPoints.map(d => d.defect_rate);

        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Defect Rate (%)',
                    data: rates,
                    borderColor: '#3B82F6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#3B82F6',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            afterLabel: (ctx) => {
                                const point = dataPoints[ctx.dataIndex];
                                return [
                                    `Defect Rate: ${point.defect_rate}%`,
                                    `Inspected: ${point.total_inspected}`,
                                    `Defects: ${point.total_defects}`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Defect Rate (%)' },
                        grid: { borderDash: [2, 4] }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // --- Dashboard Logic ---
    function updatePeriod(period, btn) {
        if (btn) {
            document.querySelectorAll('#dashboardActions .btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        currentPeriod = period;
        let days = 30;
        if (period === 'week') days = 7;
        if (period === 'year') days = 365;
        loadAnalyticsData(days);
    }

    // --- Defect List Logic ---

    // Set status filter from tabs
    function setStatusFilter(btn, status) {
        document.querySelectorAll('.status-tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('statusFilter').value = status;
        loadDefects();
    }

    // Load defect stats for summary cards
    async function loadDefectStats() {
        try {
            const res = await api.get('/qc/defects-stats');
            document.getElementById('countAll').textContent = res.total || 0;
            document.getElementById('countOpen').textContent = res.open || 0;
            document.getElementById('countInProgress').textContent = res.in_progress || 0;
            document.getElementById('countResolved').textContent = res.resolved || 0;
            document.getElementById('countClosed').textContent = res.closed || 0;

            document.getElementById('statTotalDefects').textContent = res.total || 0;
            document.getElementById('statOpenIssues').textContent = res.open || 0;
            document.getElementById('statAvgResolution').textContent = res.avg_resolution || '-';
            document.getElementById('statCriticalMajor').textContent = (res.critical || 0) + (res.major || 0);
        } catch (e) {
            console.error('Failed to load defect stats:', e);
        }
    }

    // Quick resolve action
    async function quickResolve(id) {
        if (!confirm('Tandai defect ini sebagai Resolved?')) return;
        try {
            await api.put(`/qc/defects/${id}`, { status: 'resolved' });
            showToast('Defect berhasil ditandai Resolved', 'success');
            loadDefects();
            loadDefectStats();
        } catch (e) {
            showToast('Gagal mengubah status: ' + e.message, 'error');
        }
    }

    async function loadDefects() {
        const tbody = document.getElementById('defectTableBody');
        const status = document.getElementById('statusFilter').value;
        const stage = document.getElementById('stageFilter').value;
        const search = document.getElementById('tableSearch').value;

        tbody.innerHTML = '<tr><td colspan="7" class="text-center p-5 text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Mengambil data...</td></tr>';

        try {
            const query = new URLSearchParams({ status, stage, search });
            const res = await api.get(`/qc/defects-query?${query}`);

            if (!res || !res.defects || res.defects.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center p-5 text-muted empty-state-modern">
                            <i class="fas fa-clipboard-check"></i>
                            <p>Tidak ada data defect yang ditemukan</p>
                        </td>
                    </tr>`;
                loadDefectStats();
                return;
            }

            // Sort: open first, then in_progress, then others
            const statusOrder = { 'open': 0, 'in_progress': 1, 'resolved': 2, 'closed': 3 };
            const sorted = res.defects.sort((a, b) => {
                return (statusOrder[a.status] ?? 9) - (statusOrder[b.status] ?? 9);
            });

            tbody.innerHTML = sorted.map(d => `
                <tr>
                    <td class="ps-4">
                        <div class="fw-bold text-dark">${d.created_at ? new Date(d.created_at).toLocaleDateString() : '-'}</div>
                        <div class="text-xs text-muted">${d.created_at ? new Date(d.created_at).toLocaleTimeString().slice(0, 5) : ''}</div>
                    </td>
                    <td>
                        <div class="badge bg-light text-dark mb-1 border">${d.order_code || 'N/A'}</div>
                        <div class="text-sm fw-medium text-truncate" style="max-width: 150px;" title="${d.product_name || ''}">${d.product_name || '-'}</div>
                    </td>
                    <td>
                        <div class="fw-bold text-primary">${d.defect_type}</div>
                        <div class="text-xs text-muted text-truncate" style="max-width: 200px;">${d.description || ''}</div>
                    </td>
                    <td><span class="badge bg-secondary bg-opacity-10 text-secondary border">${d.process_stage || '-'}</span></td>
                    <td><div class="text-sm">${d.responsible_department || '-'}</div></td>
                    <td>${getStatusBadge(d.status)}</td>
                    <td class="text-end pe-4">
                        ${d.status === 'open' || d.status === 'in_progress' ?
                    `<button class="btn-quick-resolve me-1" onclick="quickResolve(${d.id})" title="Mark Resolved">
                                <i class="fas fa-check"></i> Resolve
                            </button>` : ''
                }
                        <button class="btn btn-sm btn-icon btn-ghost text-primary" onclick="editDefect(${d.id})" title="Edit Detail">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            loadDefectStats();

        } catch (e) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger p-4">Gagal memuat data: ${e.message}</td></tr>`;
        }
    }

    function getStatusBadge(status) {
        const styles = {
            'open': 'background:#FEE2E2; color:#B91C1C; border: 1px solid #FECACA;',
            'in_progress': 'background:#FEF3C7; color:#B45309; border: 1px solid #FDE68A;',
            'resolved': 'background:#D1FAE5; color:#047857; border: 1px solid #A7F3D0;',
            'closed': 'background:#F3F4F6; color:#374151; border: 1px solid #E5E7EB;',
        };
        const labels = {
            'open': 'Open',
            'in_progress': 'Progress',
            'resolved': 'Resolved',
            'closed': 'Closed',
        };
        return `<span class="status-badge" style="${styles[status] || styles.open}">
                    <i class="fas fa-circle me-1" style="font-size: 6px; vertical-align: middle;"></i>${labels[status] || status}
                </span>`;
    }

    // --- Modal & Form Logic ---
    function setupSelect2() {
        // Dynamic Loader for jQuery + Select2
        const loadSelect2 = () => {
            if (typeof $.fn.select2 === 'undefined') {
                const s2Script = document.createElement('script');
                s2Script.src = "https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js";
                s2Script.onload = () => initSelect2Internal();
                document.head.appendChild(s2Script);
            } else {
                initSelect2Internal();
            }
        };

        if (typeof jQuery === 'undefined') {
            const jqScript = document.createElement('script');
            jqScript.src = "https://code.jquery.com/jquery-3.7.1.min.js";
            jqScript.onload = loadSelect2;
            document.head.appendChild(jqScript);
        } else {
            loadSelect2();
        }
    }

    function initSelect2Internal() {
        $('#taskSelect').select2({
            dropdownParent: $('#defectModal'),
            placeholder: 'Cari Order / Produk...',
            allowClear: true,
            ajax: {
                url: '/api/production/search-tasks',
                dataType: 'json',
                delay: 250,
                processResults: function (data) {
                    return { results: data.results };
                }
            }
        }).on('select2:select', function (e) {
            autoFillProductInfo(e.params.data);
        });

        $('#responsibleDept').select2({
            dropdownParent: $('#defectModal'),
            placeholder: 'Cari Employee...',
            allowClear: true,
            ajax: {
                url: '/api/employees',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        search: params.term,
                        page: params.page || 1
                    };
                },
                processResults: function (data) {
                    const employees = (data.data && data.data.employees) || data.employees || [];
                    return {
                        results: employees.map(e => ({
                            id: e.name, // Using name as value because back-end stores it as string
                            text: `[${e.employee_code}] ${e.name} - ${e.position}`
                        }))
                    };
                }
            }
        });
    }

    function openDefectModal() {
        // Reset Form
        document.getElementById('defectId').value = '';
        $('#taskSelect').val(null).trigger('change');

        // Reset Inputs
        const inputs = ['customerName', 'orderCode', 'productName', 'station', 'defectType',
            'defectDescription', 'actionTaken', 'targetDate', 'verificationNotes', 'resolutionDate'];
        inputs.forEach(id => document.getElementById(id).value = '');

        $('#responsibleDept').val(null).trigger('change');

        document.getElementById('defectQty').value = '1';
        document.getElementById('finalStatus').value = 'open';
        document.getElementById('findingDate').valueAsDate = new Date(); // Default Today

        // Reset Radios
        document.querySelectorAll('input[name="processStage"]').forEach(el => el.checked = false);
        document.querySelectorAll('input[name="verificationResult"]').forEach(el => el.checked = false);

        openModal('defectModal');
    }

    function autoFillProductInfo(data) {
        if (!data) return;
        document.getElementById('customerName').value = data.customer_name || '';
        document.getElementById('orderCode').value = data.order_code || '';
        document.getElementById('productName').value = data.product_name || '';

        // Auto-select stage if returned
        if (data.process_stage) {
            const radio = document.querySelector(`input[name="processStage"][value="${data.process_stage}"]`);
            if (radio) radio.checked = true;
        }
    }

    async function saveDefect() {
        const id = document.getElementById('defectId').value;
        const taskData = $('#taskSelect').select2('data')[0];

        const processStageEl = document.querySelector('input[name="processStage"]:checked');
        const verificationEl = document.querySelector('input[name="verificationResult"]:checked');

        const payload = {
            production_task_id: taskData ? taskData.id : null,
            finding_date: document.getElementById('findingDate').value,
            process_stage: processStageEl ? processStageEl.value : null,
            station: document.getElementById('station').value,
            defect_type: document.getElementById('defectType').value,
            qty_defect: parseInt(document.getElementById('defectQty').value) || 1,
            description: document.getElementById('defectDescription').value,
            action_taken: document.getElementById('actionTaken').value,
            responsible_department: $('#responsibleDept').val(),
            target_resolution_date: document.getElementById('targetDate').value,
            verification_result: verificationEl ? verificationEl.value : null,
            verification_notes: document.getElementById('verificationNotes').value,
            status: document.getElementById('finalStatus').value,
            resolved_at_custom: document.getElementById('resolutionDate').value
        };

        if (!payload.defect_type) {
            alert('Wajib mengisi Jenis Defect');
            return;
        }

        // If creating new input, task IS required for linking context
        if (!id && !payload.production_task_id) {
            alert('Wajib memilih Order/Produk untuk input baru');
            return;
        }

        try {
            if (id) {
                await api.put(`/qc/defects/${id}`, payload);
            } else {
                await api.post('/qc/defects', payload);
            }
            closeModal('defectModal');
            showToast('Data Defect berhasil disimpan', 'success');

            // Reload active tab data
            if (document.getElementById('tab-input').classList.contains('active')) {
                loadDefects();
            } else {
                loadDashboardData();
            }
        } catch (e) {
            alert('Gagal menyimpan: ' + e.message);
        }
    }

    // Helper: Debounce for search
    function debounce(func, wait) {
        let timeout;
        return function () {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, arguments), wait);
        };
    }

    // Helper: Number Animation
    function animateValue(objId, end) {
        const obj = document.getElementById(objId);
        if (!obj) return;
        // Simple set for now
        obj.textContent = end;
    }

    async function editDefect(id) {
        try {
            showLoading('Mengambil data detail...');
            const defect = await api.get(`/qc/defects/${id}`);

            // Populate hidden ID
            document.getElementById('defectId').value = defect.id;

            // Populate Select2
            if (defect.production_task_id) {
                const option = new Option(
                    `[${defect.order_code}] ${defect.product_name}`,
                    defect.production_task_id,
                    true,
                    true
                );
                $('#taskSelect').append(option).trigger('change');
            }

            // Populate Info Card (Readonly)
            document.getElementById('customerName').value = defect.customer_name || '';
            document.getElementById('orderCode').value = defect.order_code || '';
            document.getElementById('productName').value = defect.product_name || '';

            // Step 1: Detail Temuan
            document.getElementById('findingDate').value = defect.created_at ? defect.created_at.split('T')[0] : '';
            document.getElementById('station').value = defect.station || '';
            document.getElementById('defectType').value = defect.defect_type || '';
            document.getElementById('defectQty').value = defect.qty_defect || 1;
            document.getElementById('defectDescription').value = defect.description || '';

            // Step 2: Penanganan
            document.getElementById('actionTaken').value = defect.action_taken || '';
            document.getElementById('responsibleDept').value = defect.responsible_department || '';
            document.getElementById('targetDate').value = defect.target_resolution_date || '';

            // Step 3: Verifikasi
            // Radio Stage
            if (defect.process_stage) {
                const stageRadio = document.querySelector(`input[name="processStage"][value="${defect.process_stage}"]`);
                if (stageRadio) stageRadio.checked = true;
            }

            // Radio Verification Result
            if (defect.verification_result) {
                const verRadio = document.querySelector(`input[name="verificationResult"][value="${defect.verification_result}"]`);
                if (verRadio) verRadio.checked = true;
            }

            document.getElementById('finalStatus').value = defect.status || 'open';
            document.getElementById('verificationNotes').value = defect.verification_notes || '';
            document.getElementById('resolutionDate').value = defect.resolved_at ? defect.resolved_at.split('T')[0] : '';

            // Populate Employee Select2
            if (defect.responsible_department) {
                const empOption = new Option(defect.responsible_department, defect.responsible_department, true, true);
                $('#responsibleDept').append(empOption).trigger('change');
            } else {
                $('#responsibleDept').val(null).trigger('change');
            }

            openModal('defectModal');
            hideLoading();
        } catch (e) {
            hideLoading();
            showToast('Gagal memuat detail defect: ' + e.message, 'error');
        }
    }
</script>
{% endblock %}